{
    "url": "https://api.github.com/repos/rapidsai/cudf/issues/14521",
    "repository_url": "https://api.github.com/repos/rapidsai/cudf",
    "labels_url": "https://api.github.com/repos/rapidsai/cudf/issues/14521/labels{/name}",
    "comments_url": "https://api.github.com/repos/rapidsai/cudf/issues/14521/comments",
    "events_url": "https://api.github.com/repos/rapidsai/cudf/issues/14521/events",
    "html_url": "https://github.com/rapidsai/cudf/issues/14521",
    "id": 2015198786,
    "node_id": "I_kwDOBWUGps54HX5C",
    "number": 14521,
    "title": "[BUG] `pyarrow.table` does not accept `cudf.pandas.DataFrame`",
    "user": {
        "login": "galipremsagar",
        "id": 11664259,
        "node_id": "MDQ6VXNlcjExNjY0MjU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/11664259?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/galipremsagar",
        "html_url": "https://github.com/galipremsagar",
        "followers_url": "https://api.github.com/users/galipremsagar/followers",
        "following_url": "https://api.github.com/users/galipremsagar/following{/other_user}",
        "gists_url": "https://api.github.com/users/galipremsagar/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/galipremsagar/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/galipremsagar/subscriptions",
        "organizations_url": "https://api.github.com/users/galipremsagar/orgs",
        "repos_url": "https://api.github.com/users/galipremsagar/repos",
        "events_url": "https://api.github.com/users/galipremsagar/events{/privacy}",
        "received_events_url": "https://api.github.com/users/galipremsagar/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 599626559,
            "node_id": "MDU6TGFiZWw1OTk2MjY1NTk=",
            "url": "https://api.github.com/repos/rapidsai/cudf/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        },
        {
            "id": 1139741213,
            "node_id": "MDU6TGFiZWwxMTM5NzQxMjEz",
            "url": "https://api.github.com/repos/rapidsai/cudf/labels/Python",
            "name": "Python",
            "color": "1d76db",
            "default": false,
            "description": "Affects Python cuDF API."
        },
        {
            "id": 6815620706,
            "node_id": "LA_kwDOBWUGps8AAAABlj4eYg",
            "url": "https://api.github.com/repos/rapidsai/cudf/labels/cudf.pandas",
            "name": "cudf.pandas",
            "color": "984DFB",
            "default": false,
            "description": "Issues specific to cudf.pandas"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": {
        "url": "https://api.github.com/repos/rapidsai/cudf/milestones/35",
        "html_url": "https://github.com/rapidsai/cudf/milestone/35",
        "labels_url": "https://api.github.com/repos/rapidsai/cudf/milestones/35/labels",
        "id": 10812591,
        "node_id": "MI_kwDOBWUGps4ApPyv",
        "number": 35,
        "title": "Proxying - cudf.pandas",
        "description": "",
        "creator": {
            "login": "galipremsagar",
            "id": 11664259,
            "node_id": "MDQ6VXNlcjExNjY0MjU5",
            "avatar_url": "https://avatars.githubusercontent.com/u/11664259?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/galipremsagar",
            "html_url": "https://github.com/galipremsagar",
            "followers_url": "https://api.github.com/users/galipremsagar/followers",
            "following_url": "https://api.github.com/users/galipremsagar/following{/other_user}",
            "gists_url": "https://api.github.com/users/galipremsagar/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/galipremsagar/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/galipremsagar/subscriptions",
            "organizations_url": "https://api.github.com/users/galipremsagar/orgs",
            "repos_url": "https://api.github.com/users/galipremsagar/repos",
            "events_url": "https://api.github.com/users/galipremsagar/events{/privacy}",
            "received_events_url": "https://api.github.com/users/galipremsagar/received_events",
            "type": "User",
            "site_admin": false
        },
        "open_issues": 16,
        "closed_issues": 13,
        "state": "open",
        "created_at": "2024-04-12T16:41:23Z",
        "updated_at": "2024-06-03T21:47:19Z",
        "due_on": null,
        "closed_at": null
    },
    "comments": 5,
    "created_at": "2023-11-28T19:55:10Z",
    "updated_at": "2024-05-16T05:09:17Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "### Background\r\n\r\nMost of pyarrow is implemented in Cython. They have a lazy-loaded pandas-shim which they use to interoperate with pandas. This is implemented as the `_PandasAPIShim` `cdef` class. There is a singleton shim object that is accessible as `pyarrow.lib._pandas_api` from python (and as both `pyarrow.lib._pandas_api` and `pyarrow.lib.pandas_api` from cython):\r\n```\r\nIn [1]: import pyarrow\r\nIn [2]: pyarrow.lib.pandas_api\r\n---------------------------------------------------------------------------\r\nAttributeError                            Traceback (most recent call last)\r\nCell In[2], line 1\r\n----> 1 pyarrow.lib.pandas_api\r\n\r\nAttributeError: module 'pyarrow.lib' has no attribute 'pandas_api'\r\n\r\nIn [3]: pyarrow.lib._pandas_api\r\nOut[3]: <pyarrow.lib._PandasAPIShim at 0x7f3838413c10>\r\n```\r\n\r\nSo at import time we make this API shim, and then it lazily initialises itself on first use.\r\n\r\nThis object saves a number of things:\r\n\r\n1. The observed pandas module it exported (by doing `import pandas; self.pandas = pandas`)\r\n2. Various type constructors (e.g. `self.data_frame = pandas.DataFrame`)\r\n\r\nThe first is relatively unproblematic. What we would like is for that module to be our intercepted wrapped module, which we can arrange with a little bit of rejigging of imports in cudf. It is the memoisation of the type constructors that is the problematic thing.\r\n\r\n### cudf.pandas wrapping scheme\r\nRecall that the way our wrapping scheme works is that we deliver wrapped _modules_ and decide at `__getattr__` time whether any attribute lookups deliver real or wrapped attributes. So:\r\n\r\n```\r\n%load_ext cudf.pandas\r\n\r\nimport pandas as pd # pd is _always_ a wrapped module\r\n\r\nDataFrame = pd.DataFrame # this is context-dependant either a real or wrapped constructor\r\n```\r\n\r\nThis works well, as long as someone doesn't memoise an attribute lookup. If they do, we only get to make the decision about what type of attribute to deliver once:\r\n\r\n```\r\nIn [1]: %load_ext cudf.pandas\r\n\r\nIn [3]: from cudf.pandas.module_finder import disable_transparent_mode_if_enabled\r\n\r\nIn [4]: with disable_transparent_mode_if_enabled():\r\n   ...:     from pandas import DataFrame\r\n   ...: \r\n\r\nIn [5]: DataFrame\r\nOut[5]: pandas.core.frame.DataFrame\r\n\r\nIn [6]: from pandas import DataFrame\r\n\r\nIn [7]: DataFrame\r\nOut[7]: cudf.pandas._wrappers.pandas.DataFrame\r\n```\r\n\r\nUnfortunately, pyarrow's pandas shim does exactly this. And we can't make the right decision, because sometimes (when used inside cudf) we need to deliver real objects, other times (when the user is using pyarrow) we need to deliver wrapped ones.\r\n\r\nI said it would be a miracle if @shwina's approach worked, and it _kind of_ does, but unfortunately it's not quite miraculous enough. Here's what's going on:\r\n\r\n`pa.table` uses `pa.lib._pandas_api.is_data_frame` to determine if the passed object is a pandas dataframe. The leading underscore here is crucial! This is a python object that we can replace. Similarly, `pa.Table.from_pandas` calls out to some Python code that uses `pa.lib._pandas_api` (which we can control).\r\n\r\nHowever, the `to_pandas` method on the resulting object calls `pyarrow.lib.pandas_api.data_frame` note _no_ leading underscore. This is a Cython level module attribute that we _can't_ replace from Python.\r\n\r\nSo, we have this:\r\n\r\n```\r\n%load_ext cudf.pandas\r\n\r\nimport pyarrow as pa\r\npa.lib._pandas_api = pa.lib._PandasAPIShim()\r\npa.lib.pandas_api = pa.lib._pandas_api # this doesn't do anything at the Cython level\r\n\r\nimport pandas as pd\r\ndf = pd.DataFrame({\"a\": [1, 2, 3]})\r\ntab = pa.table(df) # works\r\ndf2 = tab.to_pandas()\r\n\r\nprint(type(df))\r\n# <class 'cudf.pandas._wrappers.pandas.DataFrame'>\r\nprint(type(df2))\r\n# <class 'pandas.core.frame.DataFrame'>\r\n```\r\n\r\n### What if we initialise the Cython level object with wrapped attributes?\r\n\r\nThis seems like it might work, we have to be a bit careful about how we're importing pyarrow in cudf, but we can make this work so that `pa.lib.pandas_api` is a shim wrapper that sees our wrapped attributes.\r\n\r\n_But_ the memoisation breaks things, because inside cudf we use `to_arrow().to_pandas()` in various places to produce an honest-to-goodness pandas object, but this will now produce a wrapped object (and wrapping things in a `disable_transparent_mode_if_enabled()` context manager won't help because we _already_ took the decision about what constructor to deliver).\r\n\r\n### Options\r\n\r\n1. Convince the arrow folks that the memoisation of attribute lookup in their pandas shim is not really a performance win, and that it would be convenient if they just used `self.pandas.DataFrame`. This would allow us to (context-dependently) provide a real or wrapped object as appropriate. We would likely do this after releasing cudf-PAM since then the motivation is clear.\r\n2. Rather than letting module attribute lookup be context dependent, always deliver wrapped types such that the constructor context-dependently decides whether or not to deliver a real or wrapped type.\r\n3. Something else?\r\n\r\n\r\n\r\n**Steps/Code to reproduce bug**\r\n```python\r\nIn [1]: %load_ext cudf.pandas\r\n\r\nIn [2]: import pandas as pd\r\n\r\nIn [3]: df = pd.DataFrame({'a': [1, 2, 3]})\r\n\r\nIn [4]: import pyarrow as pa\r\n\r\nIn [5]: pa.table(df)\r\n---------------------------------------------------------------------------\r\nTypeError                                 Traceback (most recent call last)\r\nCell In[5], line 1\r\n----> 1 pa.table(df)\r\n\r\nFile /nvme/0/pgali/envs/cudfdev/lib/python3.10/site-packages/pyarrow/table.pxi:5165, in pyarrow.lib.table()\r\n\r\nTypeError: Expected pandas DataFrame, python dictionary or list of arrays\r\n```\r\n\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/rapidsai/cudf/issues/14521/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/rapidsai/cudf/issues/14521/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
{
    "url": "https://api.github.com/repos/rapidsai/cudf/issues/9430",
    "repository_url": "https://api.github.com/repos/rapidsai/cudf",
    "labels_url": "https://api.github.com/repos/rapidsai/cudf/issues/9430/labels{/name}",
    "comments_url": "https://api.github.com/repos/rapidsai/cudf/issues/9430/comments",
    "events_url": "https://api.github.com/repos/rapidsai/cudf/issues/9430/events",
    "html_url": "https://github.com/rapidsai/cudf/issues/9430",
    "id": 1025296650,
    "node_id": "I_kwDOBWUGps49HMkK",
    "number": 9430,
    "title": "[BUG] JNI testORCWriteToBufferChunked fails if `device_write_async` just returns a future",
    "user": {
        "login": "abellina",
        "id": 1901059,
        "node_id": "MDQ6VXNlcjE5MDEwNTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1901059?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/abellina",
        "html_url": "https://github.com/abellina",
        "followers_url": "https://api.github.com/users/abellina/followers",
        "following_url": "https://api.github.com/users/abellina/following{/other_user}",
        "gists_url": "https://api.github.com/users/abellina/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/abellina/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/abellina/subscriptions",
        "organizations_url": "https://api.github.com/users/abellina/orgs",
        "repos_url": "https://api.github.com/users/abellina/repos",
        "events_url": "https://api.github.com/users/abellina/events{/privacy}",
        "received_events_url": "https://api.github.com/users/abellina/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 599626559,
            "node_id": "MDU6TGFiZWw1OTk2MjY1NTk=",
            "url": "https://api.github.com/repos/rapidsai/cudf/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        },
        {
            "id": 1405145623,
            "node_id": "MDU6TGFiZWwxNDA1MTQ1NjIz",
            "url": "https://api.github.com/repos/rapidsai/cudf/labels/Java",
            "name": "Java",
            "color": "006b75",
            "default": false,
            "description": "Affects Java cuDF API."
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "vuule",
        "id": 16005690,
        "node_id": "MDQ6VXNlcjE2MDA1Njkw",
        "avatar_url": "https://avatars.githubusercontent.com/u/16005690?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vuule",
        "html_url": "https://github.com/vuule",
        "followers_url": "https://api.github.com/users/vuule/followers",
        "following_url": "https://api.github.com/users/vuule/following{/other_user}",
        "gists_url": "https://api.github.com/users/vuule/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/vuule/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/vuule/subscriptions",
        "organizations_url": "https://api.github.com/users/vuule/orgs",
        "repos_url": "https://api.github.com/users/vuule/repos",
        "events_url": "https://api.github.com/users/vuule/events{/privacy}",
        "received_events_url": "https://api.github.com/users/vuule/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "vuule",
            "id": 16005690,
            "node_id": "MDQ6VXNlcjE2MDA1Njkw",
            "avatar_url": "https://avatars.githubusercontent.com/u/16005690?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/vuule",
            "html_url": "https://github.com/vuule",
            "followers_url": "https://api.github.com/users/vuule/followers",
            "following_url": "https://api.github.com/users/vuule/following{/other_user}",
            "gists_url": "https://api.github.com/users/vuule/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/vuule/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/vuule/subscriptions",
            "organizations_url": "https://api.github.com/users/vuule/orgs",
            "repos_url": "https://api.github.com/users/vuule/repos",
            "events_url": "https://api.github.com/users/vuule/events{/privacy}",
            "received_events_url": "https://api.github.com/users/vuule/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 8,
    "created_at": "2021-10-13T14:05:52Z",
    "updated_at": "2023-08-10T17:05:33Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "The JNI cuDF bindings have a custom writer sink. Recent changes to the `cudf::io::data_sink` api added a `device_write_async` method and we updated our custom sink to pass CI and retain the old behavior. \r\n\r\nIf I try to return a future in this API, and do the work we used to do inside of it, our java tests fail for Orc but not for Parquet. \r\n\r\n```\r\ndiff --git a/java/src/main/native/src/TableJni.cpp b/java/src/main/native/src/TableJni.cpp\r\nindex 9e07f44..da036e9 100644\r\n--- a/java/src/main/native/src/TableJni.cpp\r\n+++ b/java/src/main/native/src/TableJni.cpp\r\n@@ -145,9 +145,9 @@ public:\r\n \r\n   std::future<void> device_write_async(void const *gpu_data, size_t size,\r\n                                        rmm::cuda_stream_view stream) override {\r\n-    // Call the sync version until figuring out how to write asynchronously.\r\n-    device_write(gpu_data, size, stream);\r\n-    return std::async(std::launch::deferred, [] {});\r\n+    return std::async(std::launch::deferred, [=] {\r\n+      device_write(gpu_data, size, stream);\r\n+    });\r\n   }\r\n```\r\n\r\nTest failure:\r\n\r\n```\r\nai.rapids.cudf.CudfException: cuDF failure at: /cudf/cpp/src/io/orc/reader_impl.cu:1321: Invalid index rowgroup stream data\r\n\tat ai.rapids.cudf.Table.readORC(Native Method)\r\n\tat ai.rapids.cudf.Table.readORC(Table.java:925)\r\n\tat ai.rapids.cudf.TableTest.testORCWriteToBufferChunked(TableTest.java:7058)\r\n```\r\n\r\nDiscussing with @devavret it seems that the issue is the value of `bytes_written`. The synchronous way, `bytes_written` in the sink was guaranteed to get updated in the same stack, but with the future approach, we have no such guarantee.\r\n\r\nI am adding this issue to try and document why we worked around this, and if there's a fix to our custom sink or if it's an API that needs to get changed in cuDF.",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/rapidsai/cudf/issues/9430/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/rapidsai/cudf/issues/9430/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
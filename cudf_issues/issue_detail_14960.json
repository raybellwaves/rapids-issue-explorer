{
    "url": "https://api.github.com/repos/rapidsai/cudf/issues/14960",
    "repository_url": "https://api.github.com/repos/rapidsai/cudf",
    "labels_url": "https://api.github.com/repos/rapidsai/cudf/issues/14960/labels{/name}",
    "comments_url": "https://api.github.com/repos/rapidsai/cudf/issues/14960/comments",
    "events_url": "https://api.github.com/repos/rapidsai/cudf/issues/14960/events",
    "html_url": "https://github.com/rapidsai/cudf/issues/14960",
    "id": 2115991707,
    "node_id": "I_kwDOBWUGps5-H3ib",
    "number": 14960,
    "title": "[BUG] Consider cleaning up rmm global state modification in spilling",
    "user": {
        "login": "vyasr",
        "id": 1538165,
        "node_id": "MDQ6VXNlcjE1MzgxNjU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1538165?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vyasr",
        "html_url": "https://github.com/vyasr",
        "followers_url": "https://api.github.com/users/vyasr/followers",
        "following_url": "https://api.github.com/users/vyasr/following{/other_user}",
        "gists_url": "https://api.github.com/users/vyasr/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/vyasr/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/vyasr/subscriptions",
        "organizations_url": "https://api.github.com/users/vyasr/orgs",
        "repos_url": "https://api.github.com/users/vyasr/repos",
        "events_url": "https://api.github.com/users/vyasr/events{/privacy}",
        "received_events_url": "https://api.github.com/users/vyasr/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 599626559,
            "node_id": "MDU6TGFiZWw1OTk2MjY1NTk=",
            "url": "https://api.github.com/repos/rapidsai/cudf/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        },
        {
            "id": 1013987352,
            "node_id": "MDU6TGFiZWwxMDEzOTg3MzUy",
            "url": "https://api.github.com/repos/rapidsai/cudf/labels/0%20-%20Backlog",
            "name": "0 - Backlog",
            "color": "d4c5f9",
            "default": false,
            "description": "In queue waiting for assignment"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "madsbk",
        "id": 1041088,
        "node_id": "MDQ6VXNlcjEwNDEwODg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1041088?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madsbk",
        "html_url": "https://github.com/madsbk",
        "followers_url": "https://api.github.com/users/madsbk/followers",
        "following_url": "https://api.github.com/users/madsbk/following{/other_user}",
        "gists_url": "https://api.github.com/users/madsbk/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/madsbk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/madsbk/subscriptions",
        "organizations_url": "https://api.github.com/users/madsbk/orgs",
        "repos_url": "https://api.github.com/users/madsbk/repos",
        "events_url": "https://api.github.com/users/madsbk/events{/privacy}",
        "received_events_url": "https://api.github.com/users/madsbk/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "madsbk",
            "id": 1041088,
            "node_id": "MDQ6VXNlcjEwNDEwODg=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1041088?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madsbk",
            "html_url": "https://github.com/madsbk",
            "followers_url": "https://api.github.com/users/madsbk/followers",
            "following_url": "https://api.github.com/users/madsbk/following{/other_user}",
            "gists_url": "https://api.github.com/users/madsbk/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madsbk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madsbk/subscriptions",
            "organizations_url": "https://api.github.com/users/madsbk/orgs",
            "repos_url": "https://api.github.com/users/madsbk/repos",
            "events_url": "https://api.github.com/users/madsbk/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madsbk/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 0,
    "created_at": "2024-02-02T23:25:37Z",
    "updated_at": "2024-02-02T23:25:37Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "**Describe the bug**\r\nCurrently the SpillManager [modifies rmm's current device resource](https://github.com/rapidsai/cudf/blob/branch-24.04/python/cudf/cudf/core/buffer/spill_manager.py#L251) on construction to allow itself to detect when allocations fail and trigger spilling. However, this memory resource change is not reverted if the manager goes out of scope. This causes problems in situations where managers may be created and then deleted as was discovered in #14958.\r\n\r\n**Expected behavior**\r\nEither the spill manager should attempt to remove the modification of the mr when it is garbage collected, or the test that was skipped in #14958 should be removed. If we attempt the former, one of the challenges will be that the user could have set a different memory resource themselves.\r\n\r\nIn fact, this reveals a flaw in the current spilling logic whereby a user could enable spilling but then set the memory resource, which would invalidate the spilling approach. I'm not sure that there is a safe way to handle this right now other than modifying cudf to store a default memory resource that is passed to every algorithm rather than relying on rmm's default memory resource. That way, when spilling is enabled cudf could modify its default memory resource, and users modifying rmm's memory resource would have no effect, while attempting to modify cudf's memory resource would either raise an error or handle doing this in a spilling-safe manner (i.e. by wrapping the new memory resource in the callback adaptor).\r\n\r\nThis dovetails with some discussions in #14229 around the fact that default memory resources in libcudf's function signatures open us up to some pretty subtle ways because cuDF Python often leverages libcudf and [lib]rmm in nontrivial ways.",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/rapidsai/cudf/issues/14960/reactions",
        "total_count": 1,
        "+1": 1,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/rapidsai/cudf/issues/14960/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
{
    "url": "https://api.github.com/repos/rapidsai/cudf/issues/10432",
    "repository_url": "https://api.github.com/repos/rapidsai/cudf",
    "labels_url": "https://api.github.com/repos/rapidsai/cudf/issues/10432/labels{/name}",
    "comments_url": "https://api.github.com/repos/rapidsai/cudf/issues/10432/comments",
    "events_url": "https://api.github.com/repos/rapidsai/cudf/issues/10432/events",
    "html_url": "https://github.com/rapidsai/cudf/issues/10432",
    "id": 1168976542,
    "node_id": "I_kwDOBWUGps5FrSqe",
    "number": 10432,
    "title": "[FEA] Refactors and next steps for segmented reductions",
    "user": {
        "login": "bdice",
        "id": 3943761,
        "node_id": "MDQ6VXNlcjM5NDM3NjE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3943761?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bdice",
        "html_url": "https://github.com/bdice",
        "followers_url": "https://api.github.com/users/bdice/followers",
        "following_url": "https://api.github.com/users/bdice/following{/other_user}",
        "gists_url": "https://api.github.com/users/bdice/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/bdice/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/bdice/subscriptions",
        "organizations_url": "https://api.github.com/users/bdice/orgs",
        "repos_url": "https://api.github.com/users/bdice/repos",
        "events_url": "https://api.github.com/users/bdice/events{/privacy}",
        "received_events_url": "https://api.github.com/users/bdice/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 599626561,
            "node_id": "MDU6TGFiZWw1OTk2MjY1NjE=",
            "url": "https://api.github.com/repos/rapidsai/cudf/labels/feature%20request",
            "name": "feature request",
            "color": "a2eeef",
            "default": false,
            "description": "New feature or request"
        },
        {
            "id": 1013987352,
            "node_id": "MDU6TGFiZWwxMDEzOTg3MzUy",
            "url": "https://api.github.com/repos/rapidsai/cudf/labels/0%20-%20Backlog",
            "name": "0 - Backlog",
            "color": "d4c5f9",
            "default": false,
            "description": "In queue waiting for assignment"
        },
        {
            "id": 1139740666,
            "node_id": "MDU6TGFiZWwxMTM5NzQwNjY2",
            "url": "https://api.github.com/repos/rapidsai/cudf/labels/libcudf",
            "name": "libcudf",
            "color": "c5def5",
            "default": false,
            "description": "Affects libcudf (C++/CUDA) code."
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "davidwendt",
        "id": 45795991,
        "node_id": "MDQ6VXNlcjQ1Nzk1OTkx",
        "avatar_url": "https://avatars.githubusercontent.com/u/45795991?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidwendt",
        "html_url": "https://github.com/davidwendt",
        "followers_url": "https://api.github.com/users/davidwendt/followers",
        "following_url": "https://api.github.com/users/davidwendt/following{/other_user}",
        "gists_url": "https://api.github.com/users/davidwendt/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/davidwendt/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/davidwendt/subscriptions",
        "organizations_url": "https://api.github.com/users/davidwendt/orgs",
        "repos_url": "https://api.github.com/users/davidwendt/repos",
        "events_url": "https://api.github.com/users/davidwendt/events{/privacy}",
        "received_events_url": "https://api.github.com/users/davidwendt/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "davidwendt",
            "id": 45795991,
            "node_id": "MDQ6VXNlcjQ1Nzk1OTkx",
            "avatar_url": "https://avatars.githubusercontent.com/u/45795991?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/davidwendt",
            "html_url": "https://github.com/davidwendt",
            "followers_url": "https://api.github.com/users/davidwendt/followers",
            "following_url": "https://api.github.com/users/davidwendt/following{/other_user}",
            "gists_url": "https://api.github.com/users/davidwendt/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/davidwendt/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/davidwendt/subscriptions",
            "organizations_url": "https://api.github.com/users/davidwendt/orgs",
            "repos_url": "https://api.github.com/users/davidwendt/repos",
            "events_url": "https://api.github.com/users/davidwendt/events{/privacy}",
            "received_events_url": "https://api.github.com/users/davidwendt/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": {
        "url": "https://api.github.com/repos/rapidsai/cudf/milestones/28",
        "html_url": "https://github.com/rapidsai/cudf/milestone/28",
        "labels_url": "https://api.github.com/repos/rapidsai/cudf/milestones/28/labels",
        "id": 9686188,
        "node_id": "MI_kwDOBWUGps4Ak8ys",
        "number": 28,
        "title": "Aggregations continuous improvement",
        "description": "",
        "creator": {
            "login": "GregoryKimball",
            "id": 12725111,
            "node_id": "MDQ6VXNlcjEyNzI1MTEx",
            "avatar_url": "https://avatars.githubusercontent.com/u/12725111?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/GregoryKimball",
            "html_url": "https://github.com/GregoryKimball",
            "followers_url": "https://api.github.com/users/GregoryKimball/followers",
            "following_url": "https://api.github.com/users/GregoryKimball/following{/other_user}",
            "gists_url": "https://api.github.com/users/GregoryKimball/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/GregoryKimball/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/GregoryKimball/subscriptions",
            "organizations_url": "https://api.github.com/users/GregoryKimball/orgs",
            "repos_url": "https://api.github.com/users/GregoryKimball/repos",
            "events_url": "https://api.github.com/users/GregoryKimball/events{/privacy}",
            "received_events_url": "https://api.github.com/users/GregoryKimball/received_events",
            "type": "User",
            "site_admin": false
        },
        "open_issues": 8,
        "closed_issues": 1,
        "state": "open",
        "created_at": "2023-07-22T20:30:21Z",
        "updated_at": "2024-03-08T22:50:19Z",
        "due_on": null,
        "closed_at": null
    },
    "comments": 6,
    "created_at": "2022-03-14T22:25:36Z",
    "updated_at": "2023-07-22T20:31:34Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "This is issue contains a few proposals for improving the segmented reduction code introduced in #9621.\r\n\r\n## Investigate sort-groupby aggregations\r\n(Idea from @ttnghia)\r\n\r\nWith the ability to perform segmented reductions, sort-based groupby may be able to use [`group_offsets`](https://github.com/rapidsai/cudf/blob/57ff6f55b9fd44e8a8e10282d3f95d5f38e299ef/cpp/src/groupby/sort/sort_helper.cu#L188) to define its segments, rather than materializing a full column of sorted/monotonic [`group_labels`](https://github.com/rapidsai/cudf/blob/57ff6f55b9fd44e8a8e10282d3f95d5f38e299ef/cpp/src/groupby/sort/sort_helper.cu#L213). In effect, this allows us to replace a call to [`thrust::reduce_by_key`](https://github.com/rapidsai/cudf/blob/57ff6f55b9fd44e8a8e10282d3f95d5f38e299ef/cpp/src/groupby/sort/group_single_pass_reduction_util.cuh#L186) algorithm with a call to [`cub::DeviceSegmentedReduce::Reduce`](https://github.com/rapidsai/cudf/blob/7ff195677fc52ffc21e8c1060b0f270587d6995b/cpp/include/cudf/detail/reduction.cuh#L267), while eliminating the need to compute the `group_labels` column. I think this should be a more efficient algorithm, and also will require less intermediate memory allocation. Benchmarks should be performed when making this change.\r\n\r\n## Refactor internal use of indices to 2N style (match CUB)\r\n\r\nThe indexing scheme used for segmented reduction is currently \"N+1\", like how list offsets are indexed. We want to refactor this to use \"2N\" indexing. This would align with `cub::DeviceSegmentedReduce::Reduce` and permit greater flexibility in the API internals. [See discussion here](https://github.com/rapidsai/cudf/pull/9621#discussion_r796250853) for details.\r\n\r\n- @bdice: After discussion with @davidwendt, we decided this is not necessary in the short term. We can resolve this issue without changing the current implementation. The current implementation of N+1 aligns with segmented sort behavior. If there is a compelling need to change this in the future for expanded functionality, we can revisit.\r\n\r\n## Compound reductions like mean\r\n\r\nThe segmented reduction code currently supports \"simple\" reductions. Support for \"compound\" reductions is needed. This includes multi-step calculations like mean, standard deviation, or sum of squares. Non-segmented compound reductions are defined here: https://github.com/rapidsai/cudf/blob/c1638869116aae2c6dde6024394279a2fb79e685/cpp/src/reductions/compound.cuh\r\n\r\n## Fixes for output_type precision\r\n\r\n@isVoid and I filed #9988 while working on #9621 because the documentation doesn't align with the implementation for when data is cast to the output dtype relative to when the reduction is performed. This affects segmented reduction as well.\r\n\r\n## Explore rewriting `get_null_replacing_element_transformer` with nullate\r\n\r\nIt may be possible to clean up the [implementation of null element handling here](https://github.com/rapidsai/cudf/blob/7ff195677fc52ffc21e8c1060b0f270587d6995b/cpp/src/reductions/simple_segmented.cuh#L75-L85) by using [nullate](https://github.com/rapidsai/cudf/blob/c1638869116aae2c6dde6024394279a2fb79e685/cpp/include/cudf/column/column_device_view.cuh#L53).\r\n\r\n- @bdice: After discussion with @davidwendt, we decided this is not worth changing. It might eliminate one or two lines of duplicate code but doesn't offer any benefits to compile time.\r\n\r\n## Extend to more data types\r\n\r\nWe need to review the types supported by non-segmented reductions and ensure that segmented reductions support the same types. Decimal support has been requested here: https://github.com/rapidsai/cudf/issues/10417",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/rapidsai/cudf/issues/10432/reactions",
        "total_count": 2,
        "+1": 1,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 1,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/rapidsai/cudf/issues/10432/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8429",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8429/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8429/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8429/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/8429",
    "id": 1731636894,
    "node_id": "I_kwDOD7z77c5nNq6e",
    "number": 8429,
    "title": "[FEA] support latest version of Iceberg such as 1.2",
    "user": {
        "login": "advancedxy",
        "id": 807537,
        "node_id": "MDQ6VXNlcjgwNzUzNw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/807537?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/advancedxy",
        "html_url": "https://github.com/advancedxy",
        "followers_url": "https://api.github.com/users/advancedxy/followers",
        "following_url": "https://api.github.com/users/advancedxy/following{/other_user}",
        "gists_url": "https://api.github.com/users/advancedxy/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/advancedxy/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/advancedxy/subscriptions",
        "organizations_url": "https://api.github.com/users/advancedxy/orgs",
        "repos_url": "https://api.github.com/users/advancedxy/repos",
        "events_url": "https://api.github.com/users/advancedxy/events{/privacy}",
        "received_events_url": "https://api.github.com/users/advancedxy/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735884,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODg0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/feature%20request",
            "name": "feature request",
            "color": "a2eeef",
            "default": false,
            "description": "New feature or request"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2023-05-30T06:59:10Z",
    "updated_at": "2023-07-11T19:52:14Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "**Is your feature request related to a problem? Please describe.**\r\nCurrently, Spark for Rapids supports Iceberg [0.13.x](https://nvidia.github.io/spark-rapids/docs/additional-functionality/iceberg-support.html), it doesn't say anything about later versions of Iceberg. Users(myself included) may assume that later versions of Iceberg are supported. \r\n\r\nHowever after some experiments, running rapids with Spark 3.3.1 + Iceberg 1.2(the latest release) doesn't work.\r\nFrom the surface, there are two problems of running rapids with new versions of Iceberg: \r\n1. `isMetaScan` assumes tasks is always `CombinedScanTask`, which isn't true any more in later versions.\r\n```\r\n  public static boolean isMetadataScan(Scan cpuInstance) throws IllegalAccessException {\r\n    List<CombinedScanTask> tasks = (List<CombinedScanTask>) FieldUtils.readField(cpuInstance, \"tasks\", true);\r\n    if (tasks == null || tasks.isEmpty()) {\r\n      return true;\r\n    }\r\n    Iterator<FileScanTask> taskIter = tasks.get(0).files().iterator();\r\n    return !taskIter.hasNext() || taskIter.next().isDataTask();\r\n  }\r\n```\r\nThis could be easily solved by applying some patches:\r\n```\r\n  public static boolean isMetadataScan(Scan cpuInstance) throws IllegalAccessException {\r\n    List<FileScanTask> tasks = (List<FileScanTask>) FieldUtils.readField(cpuInstance, \"tasks\", true);\r\n    if (tasks == null || tasks.isEmpty()) {\r\n      return true;\r\n    }\r\n    Iterator<FileScanTask> taskIter;\r\n    if (tasks.get(0) instanceof CombinedScanTask) {\r\n      taskIter = ((CombinedScanTask) tasks.get(0)).files().iterator();\r\n    } else {\r\n      taskIter = tasks.iterator();\r\n    }\r\n    return !taskIter.hasNext() || taskIter.next().isDataTask();\r\n  }\r\n```\r\n\r\n2. due to interface changes, Iceberg batch scan cannot be converted GPUBatchQueryScan, therefore it's fallback to cpu version of scan.\r\n```\r\n        !Input <SparkBatchQueryScan> cannot run on GPU because conversion to GPU scan failed: org.apache.iceberg.BatchScanAdapter cannot be cast to org.apache.iceberg.TableScan\r\n        @Expression <AttributeReference> partition_time#18L could run on GPU\r\n        @Expression <AttributeReference> metric_info#42 could run on GPU\r\n```\r\nThe second one is the bigger one, it requires large code refactor and solve Iceberg support systematically, such as shim different iceberg versions similar with how spark versions are handled.\r\n\r\n**Describe the solution you'd like**\r\n1. support latest versions of Iceberg if possible and prioritize it.\r\n2. If rapids team are busy with other features and format support, do you have any estimate time when Iceberg support would be picked?\r\n\r\n\r\n**Describe alternatives you've considered**\r\nNo\r\n\r\n**Additional context**\r\n\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8429/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8429/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
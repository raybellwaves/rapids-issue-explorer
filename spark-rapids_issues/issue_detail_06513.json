{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6513",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6513/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6513/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6513/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/6513",
    "id": 1364146802,
    "node_id": "I_kwDOD7z77c5RTzpy",
    "number": 6513,
    "title": "[FEA] Casting float numbers to string may differ from CPU in ORC schema evolution",
    "user": {
        "login": "sinkinben",
        "id": 31923950,
        "node_id": "MDQ6VXNlcjMxOTIzOTUw",
        "avatar_url": "https://avatars.githubusercontent.com/u/31923950?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sinkinben",
        "html_url": "https://github.com/sinkinben",
        "followers_url": "https://api.github.com/users/sinkinben/followers",
        "following_url": "https://api.github.com/users/sinkinben/following{/other_user}",
        "gists_url": "https://api.github.com/users/sinkinben/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/sinkinben/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/sinkinben/subscriptions",
        "organizations_url": "https://api.github.com/users/sinkinben/orgs",
        "repos_url": "https://api.github.com/users/sinkinben/repos",
        "events_url": "https://api.github.com/users/sinkinben/events{/privacy}",
        "received_events_url": "https://api.github.com/users/sinkinben/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735884,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODg0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/feature%20request",
            "name": "feature request",
            "color": "a2eeef",
            "default": false,
            "description": "New feature or request"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2022-09-07T06:16:25Z",
    "updated_at": "2022-09-07T20:07:52Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "**Is your feature request related to a problem? Please describe.**\r\n\r\nAs mentioned in [#6319](https://github.com/NVIDIA/spark-rapids/pull/6319#discussion_r957418173), when casting float/double to string (i.e. ORC schema evolution) in GPU, the result may differ from result of CPU, since the precision of float numbers in GPU differ from CPU.\r\n\r\nAt present, we implement this via\r\n```scala\r\n      // Code in GpuOrcScan.scala\r\n      // float/double to string\r\n      // cuDF keep 9 decimal numbers after the decimal point, and CPU keeps more than 10.\r\n      // So when casting float/double to string, the result of GPU is different from CPU.\r\n      case (DType.FLOAT32 | DType.FLOAT64, DType.STRING) =>\r\n        GpuCast.castFloatingTypeToString(col)\r\n```\r\nAnd we let `'spark.rapids.sql.format.orc.floatTypesToString.enable'` to control it's enable or not. Its default value is `true`, if it's set `false` explicitly, then we ban `float/double -> string` in ORC reading.\r\n\r\n\r\n**Example - Schema Evolution of ORC Reading**\r\nFirstly, create an ORC file.\r\n```scala\r\nval data =Seq((3.141592.toFloat, 3.141592653589793.toDouble))\r\nval columns=Seq(\"float_col\", \"double_col\")\r\nval df=spark.createDataFrame(data).toDF(columns:_*).repartition(1)\r\ndf.printSchema()\r\ndf.show(false)\r\ndf.write.mode(\"overwrite\").orc(\"/tmp/orc/data.orc\")\r\n```\r\n\r\nAnd then read it in by\r\n```scala\r\nspark.read.schema(\"float_col string, double_col string\").orc(\"/tmp/orc/data.orc\").show(false)\r\n```\r\n\r\n\r\nThe result of CPU is\r\n```shell\r\nscala> spark.read.schema(\"float_col string, double_col string\").orc(\"/tmp/orc/data.orc\").show(false)\r\n+-----------------+-----------------+\r\n|float_col        |double_col       |\r\n+-----------------+-----------------+\r\n|3.141592025756836|3.141592653589793|\r\n+-----------------+-----------------+\r\n```\r\n\r\nThe result of GPU is \r\n```shell\r\nscala> spark.read.schema(\"float_col string, double_col string\").orc(\"/tmp/orc/data.orc\").show(false)\r\n+-----------+-----------+\r\n|float_col  |double_col |\r\n+-----------+-----------+\r\n|3.141592026|3.141592654|\r\n+-----------+-----------+\r\n```\r\n\r\n\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6513/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6513/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
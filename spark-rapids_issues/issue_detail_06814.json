{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6814",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6814/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6814/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6814/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/6814",
    "id": 1409967128,
    "node_id": "I_kwDOD7z77c5UCmQY",
    "number": 6814,
    "title": "[BUG] spark.rapids.sql.exec.CollectLimitExec=true can mess up the CSV header row",
    "user": {
        "login": "viadea",
        "id": 9665750,
        "node_id": "MDQ6VXNlcjk2NjU3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/9665750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/viadea",
        "html_url": "https://github.com/viadea",
        "followers_url": "https://api.github.com/users/viadea/followers",
        "following_url": "https://api.github.com/users/viadea/following{/other_user}",
        "gists_url": "https://api.github.com/users/viadea/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/viadea/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/viadea/subscriptions",
        "organizations_url": "https://api.github.com/users/viadea/orgs",
        "repos_url": "https://api.github.com/users/viadea/repos",
        "events_url": "https://api.github.com/users/viadea/events{/privacy}",
        "received_events_url": "https://api.github.com/users/viadea/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735874,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODc0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "firestarman",
        "id": 7280411,
        "node_id": "MDQ6VXNlcjcyODA0MTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7280411?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/firestarman",
        "html_url": "https://github.com/firestarman",
        "followers_url": "https://api.github.com/users/firestarman/followers",
        "following_url": "https://api.github.com/users/firestarman/following{/other_user}",
        "gists_url": "https://api.github.com/users/firestarman/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/firestarman/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/firestarman/subscriptions",
        "organizations_url": "https://api.github.com/users/firestarman/orgs",
        "repos_url": "https://api.github.com/users/firestarman/repos",
        "events_url": "https://api.github.com/users/firestarman/events{/privacy}",
        "received_events_url": "https://api.github.com/users/firestarman/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "firestarman",
            "id": 7280411,
            "node_id": "MDQ6VXNlcjcyODA0MTE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/7280411?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/firestarman",
            "html_url": "https://github.com/firestarman",
            "followers_url": "https://api.github.com/users/firestarman/followers",
            "following_url": "https://api.github.com/users/firestarman/following{/other_user}",
            "gists_url": "https://api.github.com/users/firestarman/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/firestarman/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/firestarman/subscriptions",
            "organizations_url": "https://api.github.com/users/firestarman/orgs",
            "repos_url": "https://api.github.com/users/firestarman/repos",
            "events_url": "https://api.github.com/users/firestarman/events{/privacy}",
            "received_events_url": "https://api.github.com/users/firestarman/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 5,
    "created_at": "2022-10-14T23:36:01Z",
    "updated_at": "2022-11-23T01:34:28Z",
    "closed_at": null,
    "author_association": "COLLABORATOR",
    "active_lock_reason": null,
    "body": "If we enable spark.rapids.sql.exec.CollectLimitExec=true on a 2 nodes cluster, the CSV with header may be messed up.\r\n\r\nFor example, let's use this example csv file:\r\n```\r\nwget -q https://raw.githubusercontent.com/JohnSnowLabs/spark-nlp-workshop/master/tutorials/Certification_Trainings/Public/data/news_category_train.csv\r\n```\r\n\r\nThe format of this csv file is like this:\r\n```\r\ncategory,description\r\nBusiness,\" Short sellers, Wall Street's dwindling band of ultra cynics, are seeing green again.\"\r\nBusiness,\" Private investment firm Carlyle Group, which has a reputation for making well timed and occasionally controversial plays in the defense industry, has quietly placed its bets on another part of the market.\"\r\nBusiness, Soaring crude prices plus worries about the economy and the outlook for earnings are expected to hang over the stock market next week during the depth of the summer doldrums.\r\n```\r\n\r\nI can reproduce the issue in both databricks and dataproc.\r\nHere is the minimum repro on dataproc:\r\n1. After a 2-nodes Dataproc cluster is ready, ssh to master node\r\n```\r\ngcloud compute ssh $CLUSTER_NAME-w-0 --project=rapids-spark --zone=$ZONE\r\nwget -q https://raw.githubusercontent.com/JohnSnowLabs/spark-nlp-workshop/master/tutorials/Certification_Trainings/Public/data/news_category_train.csv\r\nhadoop fs -put news_category_train.csv /tmp/\r\n```\r\n\r\n2. in spark-shell\r\n```\r\nspark.conf.set(\"spark.rapids.sql.exec.CollectLimitExec\",true)\r\nspark.read.option(\"header\", true).csv(\"/tmp/news_category_train.csv\").show(5, truncate=50)\r\n```\r\n\r\n3. run above command couple of times, some times it will show result like:\r\n```\r\nscala> spark.read.option(\"header\", true).csv(\"/tmp/news_category_train.csv\").show(5, truncate=50)\r\n+--------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\r\n|Sci/Tech|Scot Wingo, author of eBay Strategies: 10 Proven Methods to Maximize Your eBay Business, will answer reader questions about the online marketplace. Wingo is president and chief executive of ChannelAdvisor, an eBay consignment franchise.|\r\n+--------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\r\n|Business|                                                                                                                                                                                           Short sellers, Wall Street's dwindling band of...|\r\n|Business|                                                                                                                                                                                           Private investment firm Carlyle Group, which h...|\r\n```\r\n\r\nSometimes it will show correct result:\r\n```\r\nscala> spark.read.option(\"header\", true).csv(\"/tmp/news_category_train.csv\").show(5, truncate=50)\r\n+--------+--------------------------------------------------+\r\n|category|                                       description|\r\n+--------+--------------------------------------------------+\r\n|Business| Short sellers, Wall Street's dwindling band of...|\r\n|Business| Private investment firm Carlyle Group, which h...|\r\n|Business| Soaring crude prices plus worries about the ec...|\r\n|Business| Authorities have halted oil export flows from ...|\r\n|Business| Tearaway world oil prices, toppling records an...|\r\n+--------+--------------------------------------------------+\r\nonly showing top 5 rows\r\n```\r\n\r\n**Env:**\r\nI can reproduce using latest 22.10 snapshot and also 22.06GA jar\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6814/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6814/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
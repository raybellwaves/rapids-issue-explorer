{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7259",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7259/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7259/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7259/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7259",
    "id": 1477526828,
    "node_id": "I_kwDOD7z77c5YEUUs",
    "number": 7259,
    "title": "[FEA] Add new Expression execution APIs",
    "user": {
        "login": "revans2",
        "id": 3441321,
        "node_id": "MDQ6VXNlcjM0NDEzMjE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/revans2",
        "html_url": "https://github.com/revans2",
        "followers_url": "https://api.github.com/users/revans2/followers",
        "following_url": "https://api.github.com/users/revans2/following{/other_user}",
        "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
        "organizations_url": "https://api.github.com/users/revans2/orgs",
        "repos_url": "https://api.github.com/users/revans2/repos",
        "events_url": "https://api.github.com/users/revans2/events{/privacy}",
        "received_events_url": "https://api.github.com/users/revans2/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735884,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODg0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/feature%20request",
            "name": "feature request",
            "color": "a2eeef",
            "default": false,
            "description": "New feature or request"
        },
        {
            "id": 4029093938,
            "node_id": "LA_kwDOD7z77c7wJxgy",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/reliability",
            "name": "reliability",
            "color": "2654AF",
            "default": false,
            "description": "Features to improve reliability or bugs that severly impact the reliability of the plugin"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2022-12-05T21:57:24Z",
    "updated_at": "2022-12-08T16:47:43Z",
    "closed_at": null,
    "author_association": "COLLABORATOR",
    "active_lock_reason": null,
    "body": "**Is your feature request related to a problem? Please describe.**\r\nIn parallel with or after https://github.com/NVIDIA/spark-rapids/issues/7258 we should add in some new expression execution APIs to let us execute Expressions without going over memory budgets.\r\n\r\nThere are several different classes of expressions that we need to worry about.\r\n\r\n * Unknown expressions. These are expressions like UDFs that have no way to fit into this pattern yet.  Hopefully once we have worked on this enough we can make some of these APIs public so Rapids UDFs can fit into this pattern too.\r\n * Up front expressions. These are expressions that we can know with high accuracy exactly how much memory that they will take to process and output a result based only on the number of rows of input. Things like Add that take a fixed input and produce a fixed output all within a single kernel fit in this category.\r\n * Predictable expressions. These are expressions that we can know about how much memory will be needed to process the data, but they need the actual data to do this prediction.\r\n * Stateful/Modifying expressions. These are expressions like IF/ELSE with children that have side effects, or many expressions that take higher order functions. These are special because they actually change the batch that is passed down to their children and keep some state around. In the case of IF/ELSE it can split the rows in almost random ways. In the case of many higher order functions, they can explode out the input data and keep original offsets as state.\r\n\r\nThere are also several expressions that are really only expressions in name, because they cannot be executed by a project. These include aggregations, window functions, and explode functions. We don't need to worry about them in this context.\r\n\r\nThe idea here is to take a few *up front expressions*, and a few *predictable expressions* and write some APIs along with implementations for them that would allow an execution framework to avoid running past a memory budget.  The hard part is that some expressions, like GpuCast, can be different things in different situations so we need to make sure that the APIs are somewhat dynamic and can be selected appropriately at runtime.\r\n\r\nThe idea is for *up front expressions* to provide an API that would return the output size and intermediate memory used based off of an input number of rows. *predictable expressions* would need a new execution API where the inputs to them are passed in as parameters along with a budget, instead of passing in a ColumnarBatch and letting the expression pull the answer from their children. If the expression can complete within the allotted budget, then it would just return the answer. If it could not it would return an error, not throw an error. That would let the framework decide to take action on splitting up the inputs.\r\n\r\nThis is likely going to need to be done going back and forth with the framework to execute the code. But for now I am splitting it up into a separate issue.",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7259/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7259/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
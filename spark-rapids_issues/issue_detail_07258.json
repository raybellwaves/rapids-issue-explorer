{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7258",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7258/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7258/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7258/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7258",
    "id": 1477504940,
    "node_id": "I_kwDOD7z77c5YEO-s",
    "number": 7258,
    "title": "[FEA] replace GpuProjectExec.project API with one that returns an Iterator",
    "user": {
        "login": "revans2",
        "id": 3441321,
        "node_id": "MDQ6VXNlcjM0NDEzMjE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/revans2",
        "html_url": "https://github.com/revans2",
        "followers_url": "https://api.github.com/users/revans2/followers",
        "following_url": "https://api.github.com/users/revans2/following{/other_user}",
        "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
        "organizations_url": "https://api.github.com/users/revans2/orgs",
        "repos_url": "https://api.github.com/users/revans2/repos",
        "events_url": "https://api.github.com/users/revans2/events{/privacy}",
        "received_events_url": "https://api.github.com/users/revans2/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735884,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODg0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/feature%20request",
            "name": "feature request",
            "color": "a2eeef",
            "default": false,
            "description": "New feature or request"
        },
        {
            "id": 4029093938,
            "node_id": "LA_kwDOD7z77c7wJxgy",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/reliability",
            "name": "reliability",
            "color": "2654AF",
            "default": false,
            "description": "Features to improve reliability or bugs that severly impact the reliability of the plugin"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2022-12-05T21:44:16Z",
    "updated_at": "2023-03-29T18:47:26Z",
    "closed_at": null,
    "author_association": "COLLABORATOR",
    "active_lock_reason": null,
    "body": "**Is your feature request related to a problem? Please describe.**\r\nThere are a number of limitations that CUDF places on columns of data. There are also limitations based off of the hardware that we are running on.  https://github.com/NVIDIA/spark-rapids/issues/7253 is an attempt to avoid running out of memory for operations that SparkPlan exec nodes. But most SparkPlan exec nodes use Expressions in one form or another to help implement how they process the data. It does this by trying to estimate how much memory is going to be needed to process the data. The problem with Expressions is that they are so varied that in many cases it is impossible to guess how much memory is going to be needed before we actually process it. In many cases it is also impossible to know if we are going to go over the limits that CUDF places on column vectors, even in the presence of lots of GPU memory.\r\n\r\nAs such we want to change the way in which we process expressions so that it stays under a budget instead of trying to request more data.\r\n\r\nThe first step in doing this is to remove the old API which takes a single batch as input and produces a single batch of output.  Instead we should move towards an API that looks like.\r\n\r\n```\r\ndef projectAndClose(cb: ColumnarBatch, budget: Long, targetBatchSize: Long, spillCallback: SpillCallback): Iterator[ColumnarBatch]\r\n```\r\n\r\nAnd is based off of the tiered project code that already exists.\r\n\r\nAt a minimum we need to implement enough of https://github.com/NVIDIA/spark-rapids/issues/7253 before this so that we can get the budget from the GpuMemoryLeaseManager.  In the short term this is not going to actually change the results at all. It is just going to change the API and let us find the different locations where we might run into problems trying to do this.\r\n\r\nIn the short term those problematic locations can be left for follow on issues, but we need to make sure that we file the follow on issues and figure out a plan on how to support them.",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7258/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7258/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
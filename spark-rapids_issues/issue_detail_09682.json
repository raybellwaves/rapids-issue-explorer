{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9682",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9682/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9682/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9682/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/9682",
    "id": 1991559009,
    "node_id": "I_kwDOD7z77c52tMdh",
    "number": 9682,
    "title": "[BUG] Casting FLOAT64 to DECIMAL(12,7) produces different rows from Apache Spark CPU",
    "user": {
        "login": "abellina",
        "id": 1901059,
        "node_id": "MDQ6VXNlcjE5MDEwNTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1901059?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/abellina",
        "html_url": "https://github.com/abellina",
        "followers_url": "https://api.github.com/users/abellina/followers",
        "following_url": "https://api.github.com/users/abellina/following{/other_user}",
        "gists_url": "https://api.github.com/users/abellina/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/abellina/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/abellina/subscriptions",
        "organizations_url": "https://api.github.com/users/abellina/orgs",
        "repos_url": "https://api.github.com/users/abellina/repos",
        "events_url": "https://api.github.com/users/abellina/events{/privacy}",
        "received_events_url": "https://api.github.com/users/abellina/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735874,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODc0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "thirtiseven",
        "id": 7326403,
        "node_id": "MDQ6VXNlcjczMjY0MDM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7326403?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/thirtiseven",
        "html_url": "https://github.com/thirtiseven",
        "followers_url": "https://api.github.com/users/thirtiseven/followers",
        "following_url": "https://api.github.com/users/thirtiseven/following{/other_user}",
        "gists_url": "https://api.github.com/users/thirtiseven/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/thirtiseven/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/thirtiseven/subscriptions",
        "organizations_url": "https://api.github.com/users/thirtiseven/orgs",
        "repos_url": "https://api.github.com/users/thirtiseven/repos",
        "events_url": "https://api.github.com/users/thirtiseven/events{/privacy}",
        "received_events_url": "https://api.github.com/users/thirtiseven/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "thirtiseven",
            "id": 7326403,
            "node_id": "MDQ6VXNlcjczMjY0MDM=",
            "avatar_url": "https://avatars.githubusercontent.com/u/7326403?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/thirtiseven",
            "html_url": "https://github.com/thirtiseven",
            "followers_url": "https://api.github.com/users/thirtiseven/followers",
            "following_url": "https://api.github.com/users/thirtiseven/following{/other_user}",
            "gists_url": "https://api.github.com/users/thirtiseven/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/thirtiseven/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/thirtiseven/subscriptions",
            "organizations_url": "https://api.github.com/users/thirtiseven/orgs",
            "repos_url": "https://api.github.com/users/thirtiseven/repos",
            "events_url": "https://api.github.com/users/thirtiseven/events{/privacy}",
            "received_events_url": "https://api.github.com/users/thirtiseven/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 13,
    "created_at": "2023-11-13T22:02:06Z",
    "updated_at": "2024-05-24T03:10:39Z",
    "closed_at": null,
    "author_association": "COLLABORATOR",
    "active_lock_reason": null,
    "body": "Update:\r\n\r\nThis bug was originally filed with the title: \r\n> [BUG] test_window_aggs_for_rows fails with rounding errors with DATAGEN_SEED=1698940723\r\n\r\nIt has since been established that the problem does not lie in window functions, or aggregations. The problem is with casting float64 to decimal, producing rounding errors.\r\n\r\nRepro:\r\n```scala\r\nSeq(3527.61953125).toDF(\"d\").repartition(1).selectExpr(\"CAST(d AS DECIMAL(12,7)) as_decimal\").show\r\n```\r\nThis produces different results on CPU and GPU.\r\nOn CPU:\r\n```scala\r\n+------------+\r\n|  as_decimal|\r\n+------------+\r\n|3527.6195313|\r\n+------------+\r\n```\r\nOn GPU:\r\n```scala\r\n+------------+\r\n|  as_decimal|\r\n+------------+\r\n|3527.6195312|\r\n+------------+\r\n```\r\n\r\n\r\n\r\nThe old description continues below:\r\n\r\n`test_window_aggs_for_rows` fails with `DATAGEN_SEED=1698940723`.\r\n\r\nRepro:\r\n```\r\nSPARK_RAPIDS_TEST_DATAGEN_SEED=1698940723 ./run_pyspark_from_build.sh -k test_window_aggs_for_row\\ and\\ RepeatSeq\\ and\\ Integer\\ and\\ Decimal\r\n```\r\n\r\n```\r\n [gw4]^[[36m [ 96%] ^[[0m^[[31mFAILED^[[0m ../../src/main/python/window_function_test.py::test_window_aggs_for_rows[[('a', RepeatSeq(Long)), ('b', Integer), ('c', Decimal(8,3))]-1000][DATAGEN_SEED=1698940723, IGNORE_ORDER({'local': True})]\r\n[gw4]^[[36m [ 96%] ^[[0m^[[31mFAILED^[[0m ../../src/main/python/window_function_test.py::test_window_aggs_for_rows[[('a', RepeatSeq(Long)), ('b', Integer), ('c', Decimal(8,3))]-1g][DATAGEN_SEED=1698940723, IGNORE_ORDER({'local': True})\r\n```\r\n\r\n\r\n```\r\n[2023-11-02T17:07:56.063Z]  Row(sum_c_asc=Decimal('-231179.895'), max_c_desc=Decimal('-48178.972'), min_c_asc=Decimal('-99999.999'), count_1=103, count_c=97, avg_c=Decimal('-9080.9564433'), rank_val=57, dense_rank_val=57, percent_rank_val=0.5490196078431373, row_num=57)\r\n[2023-11-02T17:07:56.064Z]  Row(sum_c_asc=Decimal('-227954.458'), max_c_desc=Decimal('89948.943'), min_c_asc=Decimal('-95651.987'), count_1=103, count_c=98, avg_c=Decimal('-598.2695306'), rank_val=82, dense_rank_val=82, percent_rank_val=0.7941176470588235, row_num=82)\r\n[2023-11-02T17:07:56.064Z]  Row(sum_c_asc=Decimal('-223873.440'), max_c_desc=Decimal('48971.237'), min_c_asc=Decimal('-86568.757'), count_1=102, count_c=94, avg_c=Decimal('9590.8501170'), rank_val=88, dense_rank_val=88, percent_rank_val=0.8613861386138614, row_num=88)\r\n[2023-11-02T17:07:56.064Z] -Row(sum_c_asc=Decimal('-220416.559'), max_c_desc=Decimal('34383.780'), min_c_asc=Decimal('-67119.262'), count_1=102, count_c=96, avg_c=Decimal('3527.6195313'), rank_val=84, dense_rank_val=84, percent_rank_val=0.8217821782178217, row_num=84)\r\n[2023-11-02T17:07:56.064Z] +Row(sum_c_asc=Decimal('-220416.559'), max_c_desc=Decimal('34383.780'), min_c_asc=Decimal('-67119.262'), count_1=102, count_c=96, avg_c=Decimal('3527.6195312'), rank_val=84, dense_rank_val=84, percent_rank_val=0.8217821782178217, row_num=84)\r\n[2023-11-02T17:07:56.064Z]  Row(sum_c_asc=Decimal('-220028.169'), max_c_desc=Decimal('2270.621'), min_c_asc=Decimal('-91351.118'), count_1=102, count_c=97, avg_c=Decimal('-4903.2057010'), rank_val=47, dense_rank_val=47, percent_rank_val=0.45544554455445546, row_num=47)\r\n[2023-11-02T17:07:56.064Z]  Row(sum_c_asc=Decimal('-219560.674'), max_c_desc=Decimal('-32132.633'), min_c_asc=Decimal('-95941.789'), count_1=102, count_c=95, avg_c=Decimal('-1184.0629789'), rank_val=4, dense_rank_val=4, percent_rank_val=0.0297029702970297, row_num=4)\r\n[2023-11-02T17:07:56.064Z]  Row(sum_c_asc=Decimal('-219399.848'), max_c_desc=Decimal('43804.921'), min_c_\r\n```",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9682/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9682/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
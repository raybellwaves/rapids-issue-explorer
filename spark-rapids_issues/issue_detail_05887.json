{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/5887",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/5887/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/5887/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/5887/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/5887",
    "id": 1280832025,
    "node_id": "I_kwDOD7z77c5MV_IZ",
    "number": 5887,
    "title": "[BUG] withResource can trigger serialization of query plan nodes",
    "user": {
        "login": "jlowe",
        "id": 1360766,
        "node_id": "MDQ6VXNlcjEzNjA3NjY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1360766?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jlowe",
        "html_url": "https://github.com/jlowe",
        "followers_url": "https://api.github.com/users/jlowe/followers",
        "following_url": "https://api.github.com/users/jlowe/following{/other_user}",
        "gists_url": "https://api.github.com/users/jlowe/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/jlowe/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jlowe/subscriptions",
        "organizations_url": "https://api.github.com/users/jlowe/orgs",
        "repos_url": "https://api.github.com/users/jlowe/repos",
        "events_url": "https://api.github.com/users/jlowe/events{/privacy}",
        "received_events_url": "https://api.github.com/users/jlowe/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735874,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODc0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2022-06-22T20:23:12Z",
    "updated_at": "2022-06-28T20:56:19Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "**Describe the bug**\r\n`withResource` is a member function rather than a static function, and thus any closure that uses this function must also serialize the corresponding object.  When `withResource` is used in the closure for an exec node's RDD columnar evaluate function, it will cause the exec node itself to become part of the closure, causing that node and any child nodes to be serialized as well.\r\n\r\n**Steps/Code to reproduce bug**\r\nApply a serialization \"poison pill\" to `GpuExec` with a patch like this:\r\n```patch\r\ndiff --git a/sql-plugin/src/main/scala/com/nvidia/spark/rapids/GpuExec.scala b/sql-plugin/src/main/scala/com/nvidia/spark/rapids/GpuExec.scala\r\nindex 5284cf8c5..ed2957757 100644\r\n--- a/sql-plugin/src/main/scala/com/nvidia/spark/rapids/GpuExec.scala\r\n+++ b/sql-plugin/src/main/scala/com/nvidia/spark/rapids/GpuExec.scala\r\n@@ -208,7 +208,11 @@ object GpuExec {\r\n   }\r\n }\r\n \r\n+class SerializationPoisonPill {}\r\n+\r\n trait GpuExec extends SparkPlan with Arm {\r\n+  protected val poisonPill = new SerializationPoisonPill()\r\n+\r\n   import GpuMetric._\r\n   def sparkSession: SparkSession = {\r\n     SparkShimImpl.sessionFromPlan(this)\r\n```\r\n\r\nThen run a query that triggers use of nodes that are using `withResource` in their RDD closures, e.g.: GpuBroadcastHashJoinExec or GpuShuffledHashJoinExec.\r\n\r\n**Expected behavior**\r\nThe query plan should not be needlessly serialized as part of an RDD evaluation function.",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/5887/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/5887/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/4034",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/4034/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/4034/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/4034/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/4034",
    "id": 1045049653,
    "node_id": "I_kwDOD7z77c4-SjE1",
    "number": 4034,
    "title": "[BUG] Shuffle with only rows/no columns can concat batches to be too large",
    "user": {
        "login": "revans2",
        "id": 3441321,
        "node_id": "MDQ6VXNlcjM0NDEzMjE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/revans2",
        "html_url": "https://github.com/revans2",
        "followers_url": "https://api.github.com/users/revans2/followers",
        "following_url": "https://api.github.com/users/revans2/following{/other_user}",
        "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
        "organizations_url": "https://api.github.com/users/revans2/orgs",
        "repos_url": "https://api.github.com/users/revans2/repos",
        "events_url": "https://api.github.com/users/revans2/events{/privacy}",
        "received_events_url": "https://api.github.com/users/revans2/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735874,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODc0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        },
        {
            "id": 2223784776,
            "node_id": "MDU6TGFiZWwyMjIzNzg0Nzc2",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/P1",
            "name": "P1",
            "color": "fbca04",
            "default": false,
            "description": "Nice to have for release"
        },
        {
            "id": 4029093938,
            "node_id": "LA_kwDOD7z77c7wJxgy",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/reliability",
            "name": "reliability",
            "color": "2654AF",
            "default": false,
            "description": "Features to improve reliability or bugs that severly impact the reliability of the plugin"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2021-11-04T18:04:33Z",
    "updated_at": "2022-04-12T21:57:20Z",
    "closed_at": null,
    "author_association": "COLLABORATOR",
    "active_lock_reason": null,
    "body": "**Describe the bug**\r\n`spark.time(spark.range(0, 2142322688L, 1, 1).repartition(2).selectExpr(s\"SUM(CAST(0 as byte))\").show())`\r\n\r\ncrashes for anyone with less than 16 GiB of free memory on their card with an out of memory error.\r\n\r\nRange outputs 8 batches (with no columns, just row counts in them to work around this same kind of issue). Then Spark shuffles that tiny amount of data all to a single task. GpuShuffleCoalesce then combines all of the batches back into a single batch and passes it off to hash aggregate, which will happily try to materialize a column of longs to do the SUM on. That column of longs is just about 16 GiB in size. We really should restrict the max batch size in terms of rows if there are no columns present to be something that assumes that we will add a long to it.  Either that or we need to have hash aggregate, and other operations, be smarter.",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/4034/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/4034/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
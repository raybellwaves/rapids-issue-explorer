{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7545",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7545/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7545/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7545/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7545",
    "id": 1549480229,
    "node_id": "I_kwDOD7z77c5cWzEl",
    "number": 7545,
    "title": "[BUG] Potential race condition for slow-to-start processes with UCX",
    "user": {
        "login": "abellina",
        "id": 1901059,
        "node_id": "MDQ6VXNlcjE5MDEwNTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1901059?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/abellina",
        "html_url": "https://github.com/abellina",
        "followers_url": "https://api.github.com/users/abellina/followers",
        "following_url": "https://api.github.com/users/abellina/following{/other_user}",
        "gists_url": "https://api.github.com/users/abellina/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/abellina/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/abellina/subscriptions",
        "organizations_url": "https://api.github.com/users/abellina/orgs",
        "repos_url": "https://api.github.com/users/abellina/repos",
        "events_url": "https://api.github.com/users/abellina/events{/privacy}",
        "received_events_url": "https://api.github.com/users/abellina/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735874,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODc0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        },
        {
            "id": 2096543664,
            "node_id": "MDU6TGFiZWwyMDk2NTQzNjY0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/shuffle",
            "name": "shuffle",
            "color": "67fc73",
            "default": false,
            "description": "things that impact the shuffle plugin"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2023-01-19T16:13:47Z",
    "updated_at": "2023-01-24T20:51:29Z",
    "closed_at": null,
    "author_association": "COLLABORATOR",
    "active_lock_reason": null,
    "body": "We see the following symptoms with UCX 1.13.1 with a DGX setup with the 22.12 released artifact:\r\n\r\n```\r\n# ucx_info -v\r\n# Version 1.13.1\r\n# Git branch '', revision 09f27c0\r\n# Configured with: --disable-logging --disable-debug --disable-assertions --disable-params-check --prefix=/usr --enable-examples --with-java=no\r\n```\r\n\r\n1. Executor starts and gets some heartbeats from peers, and establishes UCX connections using the `RapidsShuffleHeartbeatEndpoint`. But not all executors have had time to start.\r\n\r\n2. We start seeing shuffle block requests fairly quickly, and so we have a state of some of executors are connected, some are not (we should be able to handle it)\r\n\r\n3. We see the stack below. Two issues: the state of the transaction is unexpected (InProgress) and the scala match clause should have handled it, but we managed to log an error (`AM Error responding to peer 20 status=-200 msg=Trying to send a message to an executor that doesn't exist 20 for [amId=0x00000011, hdr=0x0000001400000019]`) which happens when we can't find the peer in our list of endpoints. \r\n\r\nMy guess is that there is an issue where these connections are not fully established, which could be a race in our code, and it could also be an issue with the UCX logic for endpoint establishment.\r\n\r\n```\r\n5456 23/01/19 05:49:19 ERROR UCXServerConnection: AM Error responding to peer 20 status=-200 msg=Trying to send a message to an executor that doesn't exist 20 for [amId=0x00000011, hdr=0x0000001400000019]\r\n5457 23/01/19 05:49:19 ERROR UCXTransaction: Detected an exception from user code. Dropping:\r\n5458 scala.MatchError: InProgress (of class scala.Enumeration$Val)\r\n5459         at com.nvidia.spark.rapids.shuffle.RapidsShuffleServer.$anonfun$doHandleMetadataRequest$10(RapidsShuffleServer.scala:289)\r\n5460         at com.nvidia.spark.rapids.shuffle.RapidsShuffleServer.$anonfun$doHandleMetadataRequest$10$adapted(RapidsShuffleServer.scala:288)\r\n5461         at com.nvidia.spark.rapids.Arm.withResource(Arm.scala:28)\r\n5462         at com.nvidia.spark.rapids.Arm.withResource$(Arm.scala:26)\r\n5463         at com.nvidia.spark.rapids.shuffle.RapidsShuffleServer.withResource(RapidsShuffleServer.scala:70)\r\n5464         at com.nvidia.spark.rapids.shuffle.RapidsShuffleServer.$anonfun$doHandleMetadataRequest$9(RapidsShuffleServer.scala:288)\r\n5465         at com.nvidia.spark.rapids.shuffle.ucx.UCXTransaction.$anonfun$registerCb$1(UCXTransaction.scala:172)\r\n5466         at com.nvidia.spark.rapids.shuffle.ucx.UCXTransaction.$anonfun$registerCb$1$adapted(UCXTransaction.scala:135)\r\n5467         at com.nvidia.spark.rapids.shuffle.ucx.UCXTransaction.complete(UCXTransaction.scala:314)\r\n5468         at com.nvidia.spark.rapids.shuffle.ucx.UCXTransaction.completeWithError(UCXTransaction.scala:319)\r\n5469         at com.nvidia.spark.rapids.shuffle.ucx.UCXServerConnection$$anon$3.onError(UCXConnection.scala:139)\r\n5470         at com.nvidia.spark.rapids.shuffle.ucx.UCX.$anonfun$sendActiveMessage$1(UCX.scala:552)\r\n5471         at com.nvidia.spark.rapids.shuffle.ucx.UCX.$anonfun$init$5(UCX.scala:184)\r\n5472         at com.nvidia.spark.rapids.shuffle.ucx.UCX.$anonfun$init$5$adapted(UCX.scala:178)\r\n5473         at com.nvidia.spark.rapids.Arm.withResource(Arm.scala:28)\r\n5474         at com.nvidia.spark.rapids.Arm.withResource$(Arm.scala:26)\r\n5475         at com.nvidia.spark.rapids.shuffle.ucx.UCX.withResource(UCX.scala:69)\r\n5476         at com.nvidia.spark.rapids.shuffle.ucx.UCX.$anonfun$init$2(UCX.scala:178)\r\n5477         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n5478         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n5479         at com.nvidia.spark.rapids.GpuDeviceManager$$anon$1.$anonfun$newThread$1(GpuDeviceManager.scala:345)\r\n5480         at java.lang.Thread.run(Thread.java:750)\r\n```",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7545/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7545/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
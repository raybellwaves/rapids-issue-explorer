{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10381",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10381/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10381/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10381/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/10381",
    "id": 2120426905,
    "node_id": "I_kwDOD7z77c5-YyWZ",
    "number": 10381,
    "title": "[BUG]udfCompiler produced a wrong analyzed logical plan in a UDF case on Spark 3.4.0+",
    "user": {
        "login": "GaryShen2008",
        "id": 22128535,
        "node_id": "MDQ6VXNlcjIyMTI4NTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/22128535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/GaryShen2008",
        "html_url": "https://github.com/GaryShen2008",
        "followers_url": "https://api.github.com/users/GaryShen2008/followers",
        "following_url": "https://api.github.com/users/GaryShen2008/following{/other_user}",
        "gists_url": "https://api.github.com/users/GaryShen2008/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/GaryShen2008/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/GaryShen2008/subscriptions",
        "organizations_url": "https://api.github.com/users/GaryShen2008/orgs",
        "repos_url": "https://api.github.com/users/GaryShen2008/repos",
        "events_url": "https://api.github.com/users/GaryShen2008/events{/privacy}",
        "received_events_url": "https://api.github.com/users/GaryShen2008/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735874,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODc0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2024-02-06T10:21:19Z",
    "updated_at": "2024-02-06T21:52:00Z",
    "closed_at": null,
    "author_association": "COLLABORATOR",
    "active_lock_reason": null,
    "body": "**Describe the bug**\r\nWhen enabling spark.rapids.sql.udfCompiler.enabled=true on Spark 3.4.0+, [one UT case](https://github.com/NVIDIA/spark-rapids/blob/branch-24.02/udf-compiler/src/test/scala/com/nvidia/spark/OpcodeSuite.scala#L797) failed with different result.\r\n\r\n**Steps/Code to reproduce bug**\r\nStart a Spark 3.4.0+ spark-shell with plugin 23.12.1+ and enable udfCompiler.\r\n`spark-shell --conf spark.plugins=com.nvidia.spark.SQLPlugin --conf spark.rapids.sql.udfCompiler.enabled=true`\r\n\r\nPaste below code:\r\n```\r\nimport org.apache.spark.sql.{Dataset, Row, SparkSession}\r\nimport org.apache.spark.sql.functions._\r\nimport org.apache.spark.sql.functions.{udf => makeUdf}\r\n\r\nval myudf: (String, String) => String = (a,b) => {\r\n   if (null==a) {\r\n      a\r\n   } else {\r\n      b\r\n   }\r\n}\r\nval u = makeUdf(myudf)\r\nval dataset = List((\"\",\"z\")).toDF(\"x\",\"y\")\r\nval result = dataset.withColumn(\"new\", u(col(\"x\"),col(\"y\")))\r\nval ref = dataset.withColumn(\"new\", lit(\"z\"))\r\n\r\nresult.show()\r\nref.show()\r\n\r\nresult.explain(true)\r\n```\r\n\r\n**Expected behavior**\r\nThe test should pass.\r\n\r\n**Environment details (please complete the following information)**\r\n - Environment location: spark local\r\n - Spark configuration settings related to the issue: spark.rapids.sql.udfCompiler.enabled=true\r\n\r\n**Additional context**\r\nThe issue doesn't happen on Spark 3.3.2 but observed from Spark 3.4.0.\r\nThe logical plan became wrong in Spark 3.4.0.\r\n\r\n```\r\n== Parsed Logical Plan ==\r\n'Project [x#10, y#11, UDF('x, 'y) AS new#14]\r\n+- Project [_1#5 AS x#10, _2#6 AS y#11]\r\n   +- LocalRelation [_1#5, _2#6]\r\n\r\n== Analyzed Logical Plan ==\r\nx: string, y: string, new: string\r\nProject [x#10, y#11, x#10 AS new#14]\r\n+- Project [_1#5 AS x#10, _2#6 AS y#11]\r\n   +- LocalRelation [_1#5, _2#6]\r\n\r\n== Optimized Logical Plan ==\r\nLocalRelation [x#10, y#11, new#14]\r\n\r\n== Physical Plan ==\r\nLocalTableScan [x#10, y#11, new#14]\r\n```\r\nThe output on Spark 3.3.2.\r\n```\r\n== Parsed Logical Plan ==\r\n'Project [x#10, y#11, UDF('x, 'y) AS new#14]\r\n+- Project [_1#5 AS x#10, _2#6 AS y#11]\r\n   +- LocalRelation [_1#5, _2#6]\r\n\r\n== Analyzed Logical Plan ==\r\nx: string, y: string, new: string\r\nProject [x#10, y#11, if (NOT isnotnull(x#10)) x#10 else y#11 AS new#14]\r\n+- Project [_1#5 AS x#10, _2#6 AS y#11]\r\n   +- LocalRelation [_1#5, _2#6]\r\n\r\n== Optimized Logical Plan ==\r\nLocalRelation [x#10, y#11, new#14]\r\n\r\n== Physical Plan ==\r\nLocalTableScan [x#10, y#11, new#14]\r\n```",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10381/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10381/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
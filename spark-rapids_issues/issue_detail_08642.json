{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8642",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8642/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8642/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8642/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/8642",
    "id": 1782771923,
    "node_id": "I_kwDOD7z77c5qQvDT",
    "number": 8642,
    "title": "[FEA] Cost of creating `SpillableColumnarBatch` can add up",
    "user": {
        "login": "abellina",
        "id": 1901059,
        "node_id": "MDQ6VXNlcjE5MDEwNTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1901059?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/abellina",
        "html_url": "https://github.com/abellina",
        "followers_url": "https://api.github.com/users/abellina/followers",
        "following_url": "https://api.github.com/users/abellina/following{/other_user}",
        "gists_url": "https://api.github.com/users/abellina/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/abellina/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/abellina/subscriptions",
        "organizations_url": "https://api.github.com/users/abellina/orgs",
        "repos_url": "https://api.github.com/users/abellina/repos",
        "events_url": "https://api.github.com/users/abellina/events{/privacy}",
        "received_events_url": "https://api.github.com/users/abellina/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735884,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODg0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/feature%20request",
            "name": "feature request",
            "color": "a2eeef",
            "default": false,
            "description": "New feature or request"
        },
        {
            "id": 2094500742,
            "node_id": "MDU6TGFiZWwyMDk0NTAwNzQy",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/performance",
            "name": "performance",
            "color": "d845b1",
            "default": false,
            "description": "A performance related task/issue"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2023-06-30T15:55:24Z",
    "updated_at": "2023-07-11T20:10:07Z",
    "closed_at": null,
    "author_association": "COLLABORATOR",
    "active_lock_reason": null,
    "body": "I was doing some testing with a patch that makes batches to be written spillable and I tried 100K partitions. I saw that there was quite a bit of time spent just creating `SpillableColumnarBatch` in this scenario. I added some traces and found it to be around the `NewDirectByteBuffer` call here https://github.com/rapidsai/cudf/blob/branch-23.08/java/src/main/native/src/PackedColumnMetadataJni.cpp#L26.\r\n\r\nWe are going through this code to get metadata about the batch so we can recreate the batch later on `getColumnarBatch`. This metadata is required for the UCX shuffle case, but for the spillable case it should not be required. It is used today to call `unpack` on the `contiguous_split` packed metadata.. but if we see this is expensive perhaps we should consider alternatives.\r\n\r\nAdding this to track this potential limitation as we make more and more batches spillable. One way to mitigate this may be to implement cudf::unpack without the packed metadata in Java/Scala for the corner case of no splits, as that info should be \r\nentirely dictated by the input batch (which we already have in java land).\r\n\r\nThe pink here is the creation of the direct byte buffer from JNI:\r\n![Screenshot from 2023-06-30 10-42-38](https://github.com/NVIDIA/spark-rapids/assets/1901059/45461b6b-73a6-4faf-9cec-f76d3c40c58a)\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8642/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/8642/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6435",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6435/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6435/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6435/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/6435",
    "id": 1353334923,
    "node_id": "I_kwDOD7z77c5QqkCL",
    "number": 6435,
    "title": "[BUG] a simple query returns wrong results",
    "user": {
        "login": "ilaychen",
        "id": 45047397,
        "node_id": "MDQ6VXNlcjQ1MDQ3Mzk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/45047397?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ilaychen",
        "html_url": "https://github.com/ilaychen",
        "followers_url": "https://api.github.com/users/ilaychen/followers",
        "following_url": "https://api.github.com/users/ilaychen/following{/other_user}",
        "gists_url": "https://api.github.com/users/ilaychen/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/ilaychen/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ilaychen/subscriptions",
        "organizations_url": "https://api.github.com/users/ilaychen/orgs",
        "repos_url": "https://api.github.com/users/ilaychen/repos",
        "events_url": "https://api.github.com/users/ilaychen/events{/privacy}",
        "received_events_url": "https://api.github.com/users/ilaychen/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735874,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODc0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        },
        {
            "id": 2223784586,
            "node_id": "MDU6TGFiZWwyMjIzNzg0NTg2",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/P0",
            "name": "P0",
            "color": "d93f0b",
            "default": false,
            "description": "Must have for release"
        },
        {
            "id": 2710265788,
            "node_id": "MDU6TGFiZWwyNzEwMjY1Nzg4",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/cudf_dependency",
            "name": "cudf_dependency",
            "color": "7400FF",
            "default": false,
            "description": "An issue or PR with this label depends on a new feature in cudf"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "revans2",
        "id": 3441321,
        "node_id": "MDQ6VXNlcjM0NDEzMjE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/revans2",
        "html_url": "https://github.com/revans2",
        "followers_url": "https://api.github.com/users/revans2/followers",
        "following_url": "https://api.github.com/users/revans2/following{/other_user}",
        "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
        "organizations_url": "https://api.github.com/users/revans2/orgs",
        "repos_url": "https://api.github.com/users/revans2/repos",
        "events_url": "https://api.github.com/users/revans2/events{/privacy}",
        "received_events_url": "https://api.github.com/users/revans2/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "revans2",
            "id": 3441321,
            "node_id": "MDQ6VXNlcjM0NDEzMjE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/revans2",
            "html_url": "https://github.com/revans2",
            "followers_url": "https://api.github.com/users/revans2/followers",
            "following_url": "https://api.github.com/users/revans2/following{/other_user}",
            "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
            "organizations_url": "https://api.github.com/users/revans2/orgs",
            "repos_url": "https://api.github.com/users/revans2/repos",
            "events_url": "https://api.github.com/users/revans2/events{/privacy}",
            "received_events_url": "https://api.github.com/users/revans2/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 8,
    "created_at": "2022-08-28T12:11:14Z",
    "updated_at": "2023-08-16T18:59:13Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "**Describe the bug**\r\nI'm running a simple query on both spark-rapids and spark 3.1.3 (on GCP's Dataproc clusters), and I'm getting different results.\r\nThe query I'm running (on a ~15TB dataset) is:\r\n`spark.sql(\"SELECT cntry_code, COUNT(cntry_code) as c from locations_ GROUP BY cntry_code sort by c DESC\")`\r\n\r\nThe results for pure spark 3.1.3 are:\r\n```\r\n+--------------+----------+\r\n|    cntry_code|         c|\r\n+--------------+----------+\r\n|            US| 108174267|\r\n|            GB|  28301655|\r\n|            DE|  21627123|\r\n|            FR|  12282801|\r\n|            CA|   8104623|\r\n|            AU|   7106091|\r\n|            IT|   6912796|\r\n|            ES|   5609006|\r\n+--------------+----------+\r\n```\r\n\r\nthe results for spark-rapids are:\r\n```\r\n+--------------+----------+\r\n|    cntry_code|         c|\r\n+--------------+----------+\r\n|            US| 108000877|\r\n|            GB|  28256306|\r\n|            DE|  21592682|\r\n|            FR|  12262796|\r\n|            CA|   8091397|\r\n|            AU|   7094689|\r\n|            IT|   6901487|\r\n|            ES|   5599871|\r\n+------------+------------+\r\n```\r\n\r\nThe data i'm reading is CSV type, I'll try to figure out a way to share the dataset if that's important.\r\n\r\n**Steps/Code to reproduce bug**\r\nStart two Dataproc clusters, the first one as mentioned [in here](https://nvidia.github.io/spark-rapids/docs/get-started/getting-started-gcp.html), the second one should be pure spark 3.1.3 .\r\nIn both clusters perform a similar spark sql query, such as:\r\n`spark.sql(\"SELECT cntry_code, COUNT(cntry_code) as c from locations_ GROUP BY cntry_code sort by c DESC\")`\r\nand check the results.\r\n\r\n\r\n**Expected behavior**\r\nthe outputs should be exactly the same.\r\n\r\n**Environment details (please complete the following information)**\r\n - Environment location: GCP\r\n - Spark configuration settings related to the issue\r\n for spark-rapids:\r\n```\r\nconf = SparkConf().setAppName(\"Locations\")\r\nconf.set('spark.rapids.sql.explain', 'ALL')\r\nconf.set(\"spark.executor.instances\", \"2\")\r\nconf.set(\"spark.executor.cores\", \"1\")\r\nconf.set(\"spark.task.cpus\", \"1\")\r\nconf.set(\"spark.rapids.sql.concurrentGpuTasks\", \"1\")\r\nconf.set(\"spark.executor.memory\", \"16g\")\r\nconf.set(\"spark.rapids.memory.pinnedPool.size\", \"2G\")\r\nconf.set(\"spark.executor.memoryOverhead\", \"2G\")\r\nconf.set(\"spark.executor.extraJavaOptions\", \"-Dai.rapids.cudf.prefer-pinned=true\")\r\nconf.set(\"spark.locality.wait\", \"0s\")\r\nconf.set(\"spark.sql.files.maxPartitionBytes\", \"2G\")\r\nconf.set(\"spark.sql.broadcastTimeout\", \"3000\")\r\nconf.set(\"spark.executor.resource.gpu.amount\", \"1\")\r\nconf.set(\"spark.task.resource.gpu.amount\", \"0.142\")\r\nconf.set(\"spark.plugins\", \"com.nvidia.spark.SQLPlugin\")\r\nconf.set(\"spark.rapids.sql.hasNans\", \"false\")\r\nconf.set(\"spark.rapids.sql.regexp.enabled\",\"true\")\r\nconf.set('spark.rapids.sql.variableFloatAgg.enabled', 'true')\r\nconf.set('spark.rapids.sql.csv.read.double.enabled', 'true')\r\nconf.set('spark.rapids.sql.exec.CollectLimitExec', 'true')\r\n```\r\nfor spark 3.1.3:\r\n```\r\nconf = SparkConf().setAppName(\"Locations\")\r\nconf.set(\"spark.executor.instances\", \"2\")\r\nconf.set(\"spark.executor.cores\", \"1\")\r\nconf.set(\"spark.task.cpus\", \"1\")\r\nconf.set(\"spark.executor.memory\", \"16g\")\r\nconf.set(\"spark.executor.memoryOverhead\", \"2G\")\r\nconf.set(\"spark.sql.files.maxPartitionBytes\", \"2G\")\r\nconf.set(\"spark.sql.broadcastTimeout\", \"3000\")\r\n```\r\n\r\n**Additional context**\r\nAdd any other context about the problem here.\r\n",
    "closed_by": {
        "login": "ilaychen",
        "id": 45047397,
        "node_id": "MDQ6VXNlcjQ1MDQ3Mzk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/45047397?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ilaychen",
        "html_url": "https://github.com/ilaychen",
        "followers_url": "https://api.github.com/users/ilaychen/followers",
        "following_url": "https://api.github.com/users/ilaychen/following{/other_user}",
        "gists_url": "https://api.github.com/users/ilaychen/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/ilaychen/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ilaychen/subscriptions",
        "organizations_url": "https://api.github.com/users/ilaychen/orgs",
        "repos_url": "https://api.github.com/users/ilaychen/repos",
        "events_url": "https://api.github.com/users/ilaychen/events{/privacy}",
        "received_events_url": "https://api.github.com/users/ilaychen/received_events",
        "type": "User",
        "site_admin": false
    },
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6435/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/6435/timeline",
    "performed_via_github_app": null,
    "state_reason": "reopened"
}
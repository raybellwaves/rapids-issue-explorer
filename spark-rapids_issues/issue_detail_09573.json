{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9573",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9573/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9573/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9573/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/9573",
    "id": 1968564313,
    "node_id": "I_kwDOD7z77c51VehZ",
    "number": 9573,
    "title": "[BUG] Verify that we can insert sort as needed for shuffled hash join and broadcast hash join replacement",
    "user": {
        "login": "revans2",
        "id": 3441321,
        "node_id": "MDQ6VXNlcjM0NDEzMjE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/revans2",
        "html_url": "https://github.com/revans2",
        "followers_url": "https://api.github.com/users/revans2/followers",
        "following_url": "https://api.github.com/users/revans2/following{/other_user}",
        "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
        "organizations_url": "https://api.github.com/users/revans2/orgs",
        "repos_url": "https://api.github.com/users/revans2/repos",
        "events_url": "https://api.github.com/users/revans2/events{/privacy}",
        "received_events_url": "https://api.github.com/users/revans2/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735874,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODc0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2023-10-30T14:52:10Z",
    "updated_at": "2023-10-31T20:31:16Z",
    "closed_at": null,
    "author_association": "COLLABORATOR",
    "active_lock_reason": null,
    "body": "**Describe the bug**\r\nIn Spark both shuffled hash joins and broadcast hash joins preserves the sort order of the stream side, except for full outer joins. We do not. We also don't preserve it when we replace a sort merge join, but we guarantee that we could replicate the ordering before we replace the sort merge join in case we needed to insert it back in again. I think we can get into problems with a shuffled hash join where the input may be sorted by something already that we cannot run on the GPU. In those cases we might fail to replace the query and either crash or possibly produce wrong results. I am fairly sure that we would crash, but I am not 100% sure about that.\r\n\r\n**Steps/Code to reproduce bug**\r\nI have not done this yet/ I am not sure in practice what it would take to have the order of the join preserved. I could see cases int he future where an optimization might push a sort through a join, but it does not exist today. I suspect it would involve something like the following, but only on a single task.\r\n\r\n```\r\ndf.orderBy(someUdf(col(\"data\"))).join(someOtherTable, col(\"leftId\") === col(\"rightId\"), joinType=\"leftOuter\").window(orderBy(someUdf(col(\"data\"))),...)\r\n```\r\n\r\nI mostly just want to have someone spend some time to test this out and either \r\n\r\n1) put in a check before we replace the joins that we can replicate the output ordering on the GPU\r\n2) we convince ourselves that this cannot happen\r\n3) we add in the ability to insert an ordering on the CPU, instead of just on the GPU after it was translated to the GPU.",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9573/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9573/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
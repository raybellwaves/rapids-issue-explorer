{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9870",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9870/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9870/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9870/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/9870",
    "id": 2013987314,
    "node_id": "I_kwDOD7z77c54CwHy",
    "number": 9870,
    "title": "[FEA] Set `spark.rapids.sql.allowMultipleJars` to NEVER by default",
    "user": {
        "login": "thirtiseven",
        "id": 7326403,
        "node_id": "MDQ6VXNlcjczMjY0MDM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7326403?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/thirtiseven",
        "html_url": "https://github.com/thirtiseven",
        "followers_url": "https://api.github.com/users/thirtiseven/followers",
        "following_url": "https://api.github.com/users/thirtiseven/following{/other_user}",
        "gists_url": "https://api.github.com/users/thirtiseven/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/thirtiseven/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/thirtiseven/subscriptions",
        "organizations_url": "https://api.github.com/users/thirtiseven/orgs",
        "repos_url": "https://api.github.com/users/thirtiseven/repos",
        "events_url": "https://api.github.com/users/thirtiseven/events{/privacy}",
        "received_events_url": "https://api.github.com/users/thirtiseven/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735884,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODg0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/feature%20request",
            "name": "feature request",
            "color": "a2eeef",
            "default": false,
            "description": "New feature or request"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [
        {
            "login": "thirtiseven",
            "id": 7326403,
            "node_id": "MDQ6VXNlcjczMjY0MDM=",
            "avatar_url": "https://avatars.githubusercontent.com/u/7326403?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/thirtiseven",
            "html_url": "https://github.com/thirtiseven",
            "followers_url": "https://api.github.com/users/thirtiseven/followers",
            "following_url": "https://api.github.com/users/thirtiseven/following{/other_user}",
            "gists_url": "https://api.github.com/users/thirtiseven/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/thirtiseven/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/thirtiseven/subscriptions",
            "organizations_url": "https://api.github.com/users/thirtiseven/orgs",
            "repos_url": "https://api.github.com/users/thirtiseven/repos",
            "events_url": "https://api.github.com/users/thirtiseven/events{/privacy}",
            "received_events_url": "https://api.github.com/users/thirtiseven/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 0,
    "created_at": "2023-11-28T09:16:08Z",
    "updated_at": "2023-11-28T21:48:31Z",
    "closed_at": null,
    "author_association": "COLLABORATOR",
    "active_lock_reason": null,
    "body": "**Is your feature request related to a problem? Please describe.**\r\n#9654 Added a new config `spark.rapids.sql.allowMultipleJars`, which is used to detect if there are multiple plugin/cudf/jni jars on the classpath when initializing `RapidsDriverPlugin` and `RapidsExecutorPlugin` and throw an exception if there are.\r\n\r\nCurrently it's default value is set to SAME_REVISION, which means that jars with the same revision are allowed by this detection. Ideally, we should set it to NEVER by default to avoid the following problems:\r\n\r\n- It does not detect when the dist jar is in multiple extraClassPath, $SPARK_HOME/jars, and on the user classpath via packages and jars. We have seen bugs in such deployments\u00a0https://github.com/NVIDIA/spark-rapids/issues/5796\r\n- when you have\u00a0[sql-plugin and aggregator on the classpath at the same time](https://github.com/NVIDIA/spark-rapids/pull/9654#issuecomment-1811693631) the user might be using an unintended flatbuffers dependency, the aggregator relocates flatbuffers to an internal package through the shade plugin to make sure it uses just the one from the aggregator.\r\n\r\nAdditionally, we should also provide a way to detect submoudle jars in the classpath, like adding a new config mode RECURSIVE to find out the path of submoudle jars.\r\n\r\n**Describe the solution you'd like**\r\nThe reason we didn't set the default value to `NEVER` is that it may require some breaking changes in CI, to solve it, we can:\r\n- Find any multiple jar usage from the log, and try to remove them.\r\n- Set `spark.rapids.sql.allowMultipleJars=NEVER` in CI jobs and fix failure if any.\r\n- Set default value to NEVER in code.\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9870/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9870/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
{
    "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9130",
    "repository_url": "https://api.github.com/repos/NVIDIA/spark-rapids",
    "labels_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9130/labels{/name}",
    "comments_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9130/comments",
    "events_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9130/events",
    "html_url": "https://github.com/NVIDIA/spark-rapids/issues/9130",
    "id": 1871710231,
    "node_id": "I_kwDOD7z77c5vkAgX",
    "number": 9130,
    "title": "[BUG] Bad performance when running close to maximum GPU memory capacity",
    "user": {
        "login": "revans2",
        "id": 3441321,
        "node_id": "MDQ6VXNlcjM0NDEzMjE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/revans2",
        "html_url": "https://github.com/revans2",
        "followers_url": "https://api.github.com/users/revans2/followers",
        "following_url": "https://api.github.com/users/revans2/following{/other_user}",
        "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
        "organizations_url": "https://api.github.com/users/revans2/orgs",
        "repos_url": "https://api.github.com/users/revans2/repos",
        "events_url": "https://api.github.com/users/revans2/events{/privacy}",
        "received_events_url": "https://api.github.com/users/revans2/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2061735874,
            "node_id": "MDU6TGFiZWwyMDYxNzM1ODc0",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
        },
        {
            "id": 2094500742,
            "node_id": "MDU6TGFiZWwyMDk0NTAwNzQy",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/performance",
            "name": "performance",
            "color": "d845b1",
            "default": false,
            "description": "A performance related task/issue"
        },
        {
            "id": 4029093938,
            "node_id": "LA_kwDOD7z77c7wJxgy",
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/labels/reliability",
            "name": "reliability",
            "color": "2654AF",
            "default": false,
            "description": "Features to improve reliability or bugs that severly impact the reliability of the plugin"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [
        {
            "login": "revans2",
            "id": 3441321,
            "node_id": "MDQ6VXNlcjM0NDEzMjE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/revans2",
            "html_url": "https://github.com/revans2",
            "followers_url": "https://api.github.com/users/revans2/followers",
            "following_url": "https://api.github.com/users/revans2/following{/other_user}",
            "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
            "organizations_url": "https://api.github.com/users/revans2/orgs",
            "repos_url": "https://api.github.com/users/revans2/repos",
            "events_url": "https://api.github.com/users/revans2/events{/privacy}",
            "received_events_url": "https://api.github.com/users/revans2/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 9,
    "created_at": "2023-08-29T13:43:50Z",
    "updated_at": "2023-08-30T18:25:07Z",
    "closed_at": null,
    "author_association": "COLLABORATOR",
    "active_lock_reason": null,
    "body": "**Describe the bug**\r\nI am not really sure how common this is, but I was running the scale tests. I generated data with a scale of 10 and a complexity of 500, and then ran q1, q2, and q3 (which are still WIP at https://github.com/NVIDIA/spark-rapids/pull/9089) As a side note I did boost the timeout to 10 mins.\r\n\r\nI did this on a 6 core/12 thread CPU with an a6000 configured for 4 tasks in parallel, 8 GiB of pinned memory and a spill size of 32 GiB, although only a few GB would have been enough.\r\n\r\nWhen I ran the tests the time to run the query would vary wildly. In some cases it would be 2.5 min and in other cases it would be 7.5 mins.  For q3 it even timed out a few times at 10 mins. The odd thing was that all of the time came from what appeared to be device synchronize as a part of the async allocator.  On slow runs I would see what appeared to be a tight loop of retrying allocations with a device synchronize when nothing was spillable. The GPU utilization, according to nvtop, was about 65% to 75%, but the power usage was only at about 100 watts. Also the CPU utilization for the java process was about 60% of a single core. The fast runs didn't have nearly as many device synchronizes and would have the device utilization spike to 100% then fall to 0% for a while, somewhat regularly. But the power usage showed about 180 to 300 watts.\r\n\r\nThe odd thing is that the spill was the same between the two runs and the spill time/spill read time, was also almost the same between the two runs. It is as if the device synchronize slowed down the processing in other threads massively. Not 100% sure about that. I will try to get an nsys trace of what is happening. \r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9130/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/9130/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}
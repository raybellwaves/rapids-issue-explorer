[
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1462402829",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7873#issuecomment-1462402829",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7873",
        "id": 1462402829,
        "node_id": "IC_kwDOD7z77c5XKn8N",
        "user": {
            "login": "revans2",
            "id": 3441321,
            "node_id": "MDQ6VXNlcjM0NDEzMjE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/revans2",
            "html_url": "https://github.com/revans2",
            "followers_url": "https://api.github.com/users/revans2/followers",
            "following_url": "https://api.github.com/users/revans2/following{/other_user}",
            "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
            "organizations_url": "https://api.github.com/users/revans2/orgs",
            "repos_url": "https://api.github.com/users/revans2/repos",
            "events_url": "https://api.github.com/users/revans2/events{/privacy}",
            "received_events_url": "https://api.github.com/users/revans2/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-09T16:49:52Z",
        "updated_at": "2023-03-09T16:49:52Z",
        "author_association": "COLLABORATOR",
        "body": "I have not seen a single place where rowBasedUDF is actually beneficial for performance. I would love to see some examples of where it actually helps.\r\n\r\nIf we do want to limit the impact of UDFs that cannot be on the GPU then we need to find ways to isolate from other GPU commands so we can release the semaphore while we are doing the CPU computation, and then grab it again afterwards. There are a few options on how we might be able to do that.  ",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1462402829/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1478600133",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7873#issuecomment-1478600133",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7873",
        "id": 1478600133,
        "node_id": "IC_kwDOD7z77c5YIaXF",
        "user": {
            "login": "mattahrens",
            "id": 5303895,
            "node_id": "MDQ6VXNlcjUzMDM4OTU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/5303895?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mattahrens",
            "html_url": "https://github.com/mattahrens",
            "followers_url": "https://api.github.com/users/mattahrens/followers",
            "following_url": "https://api.github.com/users/mattahrens/following{/other_user}",
            "gists_url": "https://api.github.com/users/mattahrens/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mattahrens/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mattahrens/subscriptions",
            "organizations_url": "https://api.github.com/users/mattahrens/orgs",
            "repos_url": "https://api.github.com/users/mattahrens/repos",
            "events_url": "https://api.github.com/users/mattahrens/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mattahrens/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-03-21T21:25:23Z",
        "updated_at": "2023-03-21T21:25:23Z",
        "author_association": "COLLABORATOR",
        "body": "Consider removing feature from the plugin given we haven't seen any use cases where there is a benefit.\n\n@viadea: have you seen specific use cases where enabling this flag has been beneficial from a performance standpoint?",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1478600133/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1675179097",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7873#issuecomment-1675179097",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7873",
        "id": 1675179097,
        "node_id": "IC_kwDOD7z77c5j2TRZ",
        "user": {
            "login": "viadea",
            "id": 9665750,
            "node_id": "MDQ6VXNlcjk2NjU3NTA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9665750?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/viadea",
            "html_url": "https://github.com/viadea",
            "followers_url": "https://api.github.com/users/viadea/followers",
            "following_url": "https://api.github.com/users/viadea/following{/other_user}",
            "gists_url": "https://api.github.com/users/viadea/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/viadea/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/viadea/subscriptions",
            "organizations_url": "https://api.github.com/users/viadea/orgs",
            "repos_url": "https://api.github.com/users/viadea/repos",
            "events_url": "https://api.github.com/users/viadea/events{/privacy}",
            "received_events_url": "https://api.github.com/users/viadea/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-08-11T18:08:01Z",
        "updated_at": "2023-08-11T18:08:01Z",
        "author_association": "COLLABORATOR",
        "body": "@mattahrens  I believe it might help performance if it can avoid a huge CPU fallback.\r\nBut I do not have metrics number to prove that yet since we normally enable multiple parameters in one shot. So could not really tell if this specific change is making difference or not. \r\n\r\nMaybe next time we can try to test with only enabling this specific parameter to see if it can help perf or not. \r\n",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1675179097/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1675197275",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7873#issuecomment-1675197275",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7873",
        "id": 1675197275,
        "node_id": "IC_kwDOD7z77c5j2Xtb",
        "user": {
            "login": "jlowe",
            "id": 1360766,
            "node_id": "MDQ6VXNlcjEzNjA3NjY=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1360766?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jlowe",
            "html_url": "https://github.com/jlowe",
            "followers_url": "https://api.github.com/users/jlowe/followers",
            "following_url": "https://api.github.com/users/jlowe/following{/other_user}",
            "gists_url": "https://api.github.com/users/jlowe/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jlowe/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jlowe/subscriptions",
            "organizations_url": "https://api.github.com/users/jlowe/orgs",
            "repos_url": "https://api.github.com/users/jlowe/repos",
            "events_url": "https://api.github.com/users/jlowe/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jlowe/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-08-11T18:25:24Z",
        "updated_at": "2023-08-11T18:25:24Z",
        "author_association": "MEMBER",
        "body": "As @revans2 mentioned, we've never seen a case where this helped.  We should not be asking users to turn this on unless it's isolated from other changes and we're seeing performance increases.  It should not be recommended generally at this point.",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1675197275/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1675201624",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7873#issuecomment-1675201624",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7873",
        "id": 1675201624,
        "node_id": "IC_kwDOD7z77c5j2YxY",
        "user": {
            "login": "viadea",
            "id": 9665750,
            "node_id": "MDQ6VXNlcjk2NjU3NTA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9665750?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/viadea",
            "html_url": "https://github.com/viadea",
            "followers_url": "https://api.github.com/users/viadea/followers",
            "following_url": "https://api.github.com/users/viadea/following{/other_user}",
            "gists_url": "https://api.github.com/users/viadea/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/viadea/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/viadea/subscriptions",
            "organizations_url": "https://api.github.com/users/viadea/orgs",
            "repos_url": "https://api.github.com/users/viadea/repos",
            "events_url": "https://api.github.com/users/viadea/events{/privacy}",
            "received_events_url": "https://api.github.com/users/viadea/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-08-11T18:29:47Z",
        "updated_at": "2023-08-11T18:29:47Z",
        "author_association": "COLLABORATOR",
        "body": "@nvliyuan @rwlee @SurajAralihalli  FYI here.",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1675201624/reactions",
            "total_count": 1,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 1
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1675202840",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7873#issuecomment-1675202840",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7873",
        "id": 1675202840,
        "node_id": "IC_kwDOD7z77c5j2ZEY",
        "user": {
            "login": "revans2",
            "id": 3441321,
            "node_id": "MDQ6VXNlcjM0NDEzMjE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/revans2",
            "html_url": "https://github.com/revans2",
            "followers_url": "https://api.github.com/users/revans2/followers",
            "following_url": "https://api.github.com/users/revans2/following{/other_user}",
            "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
            "organizations_url": "https://api.github.com/users/revans2/orgs",
            "repos_url": "https://api.github.com/users/revans2/repos",
            "events_url": "https://api.github.com/users/revans2/events{/privacy}",
            "received_events_url": "https://api.github.com/users/revans2/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-08-11T18:30:58Z",
        "updated_at": "2023-08-11T18:30:58Z",
        "author_association": "COLLABORATOR",
        "body": "I have plans to remove it because it causes a lot of problems with host memory management. I want to see a real world query where this actually helps. I have not seen a single one yet.",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1675202840/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1675372638",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7873#issuecomment-1675372638",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7873",
        "id": 1675372638,
        "node_id": "IC_kwDOD7z77c5j3Che",
        "user": {
            "login": "revans2",
            "id": 3441321,
            "node_id": "MDQ6VXNlcjM0NDEzMjE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/revans2",
            "html_url": "https://github.com/revans2",
            "followers_url": "https://api.github.com/users/revans2/followers",
            "following_url": "https://api.github.com/users/revans2/following{/other_user}",
            "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
            "organizations_url": "https://api.github.com/users/revans2/orgs",
            "repos_url": "https://api.github.com/users/revans2/repos",
            "events_url": "https://api.github.com/users/revans2/events{/privacy}",
            "received_events_url": "https://api.github.com/users/revans2/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-08-11T20:31:48Z",
        "updated_at": "2023-08-11T20:31:48Z",
        "author_association": "COLLABORATOR",
        "body": "Okay so I did some tests and I gave rowBaseUDF the best chance possible. I created a very small UDF that just adds two longs together.  Then using NDS data for store sales I did the following querys.\r\n\r\n```\r\nspark.time(data.selectExpr(\"SUM(ss_quantity + ss_store_sk) as something\").show())\r\nspark.time(data.selectExpr(\"SUM(my_add(ss_quantity, ss_store_sk)) as something\").show())\r\n```\r\n\r\nIn the second query it is put in as a part of the hash aggregate so it prevents the aggregate from running on the GPU.\r\n\r\n| op | + | my_add |\r\n|-|-|-|\r\n| CPU | about 2900 ms | about 3700 ms |\r\n| GPU | 412 ms | about 5300 ms |\r\n| GPU with rowBasedUDF | 412 ms | about 10300 ms (for concurrent of 4) about 7350 ms (for concurrent of 12) |\r\n\r\nFrom this it is clear that it is not about preventing computation from falling back to the CPU. In fact there are cases where it makes it worse to have this enabled. \r\n\r\nIt is all about preventing data movement. The one case that I can force this to be a benefit is when we have lots of columns that are not being touched bu just going along for the ride.\r\n\r\n```\r\nspark.time(data.selectExpr(\"*\", \"my_add(ss_quantity, ss_store_sk) as tmp\").write.mode(\"overwrite\").parquet(\"/data/tmp/OUTPUT\"))\r\nspark.time(data.selectExpr(\"*\", \"ss_quantity + ss_store_sk as tmp\").write.mode(\"overwrite\").parquet(\"/data/tmp/OUTPUT\"))\r\n```\r\n\r\n| op | + | my_add |\r\n|-|-|-|\r\n| CPU | 323363 ms | 319553 ms |\r\n| GPU |  about 28000 ms | about 86000 ms |\r\n| GPU with rowBasedUDF | about 28000 ms | about 39000 ms (for concurrent of 4) |\r\n\r\nI didn't do a concurrent of 12 here for the UDF because it stated to spill a lot.  But is this common enough that keep the config around? It is clear that we cannot turn it on all the time. There are just too many cases where it makes things worse.\r\n\r\nI still want to rip out this code because it is going to make the host memory limits much harder to implement if we don't remove it.\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1675372638/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1849473975",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7873#issuecomment-1849473975",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7873",
        "id": 1849473975,
        "node_id": "IC_kwDOD7z77c5uPLu3",
        "user": {
            "login": "nvliyuan",
            "id": 84758614,
            "node_id": "MDQ6VXNlcjg0NzU4NjE0",
            "avatar_url": "https://avatars.githubusercontent.com/u/84758614?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/nvliyuan",
            "html_url": "https://github.com/nvliyuan",
            "followers_url": "https://api.github.com/users/nvliyuan/followers",
            "following_url": "https://api.github.com/users/nvliyuan/following{/other_user}",
            "gists_url": "https://api.github.com/users/nvliyuan/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/nvliyuan/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/nvliyuan/subscriptions",
            "organizations_url": "https://api.github.com/users/nvliyuan/orgs",
            "repos_url": "https://api.github.com/users/nvliyuan/repos",
            "events_url": "https://api.github.com/users/nvliyuan/events{/privacy}",
            "received_events_url": "https://api.github.com/users/nvliyuan/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-12-11T07:35:10Z",
        "updated_at": "2023-12-11T07:35:41Z",
        "author_association": "COLLABORATOR",
        "body": "Update a case in nvbug ***8068.",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1849473975/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1852825653",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/7873#issuecomment-1852825653",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/7873",
        "id": 1852825653,
        "node_id": "IC_kwDOD7z77c5ub-A1",
        "user": {
            "login": "viadea",
            "id": 9665750,
            "node_id": "MDQ6VXNlcjk2NjU3NTA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/9665750?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/viadea",
            "html_url": "https://github.com/viadea",
            "followers_url": "https://api.github.com/users/viadea/followers",
            "following_url": "https://api.github.com/users/viadea/following{/other_user}",
            "gists_url": "https://api.github.com/users/viadea/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/viadea/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/viadea/subscriptions",
            "organizations_url": "https://api.github.com/users/viadea/orgs",
            "repos_url": "https://api.github.com/users/viadea/repos",
            "events_url": "https://api.github.com/users/viadea/events{/privacy}",
            "received_events_url": "https://api.github.com/users/viadea/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-12-12T21:18:04Z",
        "updated_at": "2023-12-12T21:18:04Z",
        "author_association": "COLLABORATOR",
        "body": "Since @nvliyuan found one specific use case where rowBasedUDF might perform better, shall we avoid deleting this feature?\r\nInstead, we keep this parameter so that advanced user can tune/test if needed.",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1852825653/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]
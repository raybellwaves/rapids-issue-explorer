[
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1904308806",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/10234#issuecomment-1904308806",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10234",
        "id": 1904308806,
        "node_id": "IC_kwDOD7z77c5xgXJG",
        "user": {
            "login": "revans2",
            "id": 3441321,
            "node_id": "MDQ6VXNlcjM0NDEzMjE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/revans2",
            "html_url": "https://github.com/revans2",
            "followers_url": "https://api.github.com/users/revans2/followers",
            "following_url": "https://api.github.com/users/revans2/following{/other_user}",
            "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
            "organizations_url": "https://api.github.com/users/revans2/orgs",
            "repos_url": "https://api.github.com/users/revans2/repos",
            "events_url": "https://api.github.com/users/revans2/events{/privacy}",
            "received_events_url": "https://api.github.com/users/revans2/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2024-01-22T15:59:11Z",
        "updated_at": "2024-01-22T15:59:11Z",
        "author_association": "COLLABORATOR",
        "body": "I ran this locally and was not able to reproduce it. \r\n\r\nI think it is the same problem as https://github.com/NVIDIA/spark-rapids/issues/9822 and https://github.com/NVIDIA/spark-rapids/issues/10026\r\n\r\nbecause average really is a `SUM(X)/COUNT(x)` and if `SUM(x)` can fail, then dividing it can also fail, but it likely to fail by less. We should look at what is the best way to mitigate these issues around floats/doubles.",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1904308806/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1973538130",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/10234#issuecomment-1973538130",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10234",
        "id": 1973538130,
        "node_id": "IC_kwDOD7z77c51oc1S",
        "user": {
            "login": "jbrennan333",
            "id": 69316431,
            "node_id": "MDQ6VXNlcjY5MzE2NDMx",
            "avatar_url": "https://avatars.githubusercontent.com/u/69316431?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jbrennan333",
            "html_url": "https://github.com/jbrennan333",
            "followers_url": "https://api.github.com/users/jbrennan333/followers",
            "following_url": "https://api.github.com/users/jbrennan333/following{/other_user}",
            "gists_url": "https://api.github.com/users/jbrennan333/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jbrennan333/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jbrennan333/subscriptions",
            "organizations_url": "https://api.github.com/users/jbrennan333/orgs",
            "repos_url": "https://api.github.com/users/jbrennan333/repos",
            "events_url": "https://api.github.com/users/jbrennan333/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jbrennan333/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2024-03-01T16:54:19Z",
        "updated_at": "2024-03-01T17:03:08Z",
        "author_association": "COLLABORATOR",
        "body": "I'm not certain this is the same issue.  I was unable to reproduce this with spark 3.3.3-scala-2.12, but it repros consistently for me with spark-3.3.3-scala-2.13 using DATAGEN_SEED= 1705756525.  I'm not sure how the scala version could affect this.  @revans2 did you test with 2.12 or 2.13?",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1973538130/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1973601319",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/10234#issuecomment-1973601319",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10234",
        "id": 1973601319,
        "node_id": "IC_kwDOD7z77c51osQn",
        "user": {
            "login": "revans2",
            "id": 3441321,
            "node_id": "MDQ6VXNlcjM0NDEzMjE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3441321?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/revans2",
            "html_url": "https://github.com/revans2",
            "followers_url": "https://api.github.com/users/revans2/followers",
            "following_url": "https://api.github.com/users/revans2/following{/other_user}",
            "gists_url": "https://api.github.com/users/revans2/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/revans2/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/revans2/subscriptions",
            "organizations_url": "https://api.github.com/users/revans2/orgs",
            "repos_url": "https://api.github.com/users/revans2/repos",
            "events_url": "https://api.github.com/users/revans2/events{/privacy}",
            "received_events_url": "https://api.github.com/users/revans2/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2024-03-01T17:32:31Z",
        "updated_at": "2024-03-01T17:32:31Z",
        "author_association": "COLLABORATOR",
        "body": "I think I only tried 2.12",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1973601319/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1977116581",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/10234#issuecomment-1977116581",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10234",
        "id": 1977116581,
        "node_id": "IC_kwDOD7z77c512Gel",
        "user": {
            "login": "jbrennan333",
            "id": 69316431,
            "node_id": "MDQ6VXNlcjY5MzE2NDMx",
            "avatar_url": "https://avatars.githubusercontent.com/u/69316431?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jbrennan333",
            "html_url": "https://github.com/jbrennan333",
            "followers_url": "https://api.github.com/users/jbrennan333/followers",
            "following_url": "https://api.github.com/users/jbrennan333/following{/other_user}",
            "gists_url": "https://api.github.com/users/jbrennan333/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jbrennan333/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jbrennan333/subscriptions",
            "organizations_url": "https://api.github.com/users/jbrennan333/orgs",
            "repos_url": "https://api.github.com/users/jbrennan333/repos",
            "events_url": "https://api.github.com/users/jbrennan333/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jbrennan333/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2024-03-04T17:34:34Z",
        "updated_at": "2024-03-04T17:34:34Z",
        "author_association": "COLLABORATOR",
        "body": "With debug logging, I have verified that the arithmetic results I am getting from the pluing with scala2.12 and 2.13 are the same.  I believe the problem here is that for some reason when I run with scala-2.13, the pytest.ini file is not being loaded, so our marks are not being honored.   There are a lot of warnings about marks when I run with scala-2.13, for example:\r\n```\r\n../../../../integration_tests/src/main/python/marks.py:20\r\n  /home/jimb/git/spark-rapids/integration_tests/src/main/python/marks.py:20: PytestUnknownMarkWarning: Unknown pytest.mark.approximate_float - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/mark.html\r\n    approximate_float = pytest.mark.approximate_float\r\n```\r\nI suspect that is why this particular test is failing in 2.13 and not in 2.12.  From the logs, I can see a difference here:\r\n```\r\nscala 2.12:\r\n============================= test session starts ==============================\r\nplatform linux -- Python 3.8.10, pytest-6.2.5, py-1.11.0, pluggy-1.0.0 -- /usr/bin/python3\r\ncachedir: .pytest_cache\r\nrootdir: /home/jimb/git/spark-rapids/integration_tests, configfile: pytest.ini\r\nplugins: xdist-2.4.0, forked-1.3.0\r\ncollecting ... collected 26674 items / 26673 deselected / 1 selected\r\n```\r\n```\r\nscala 2.13:\r\n============================= test session starts ==============================\r\nplatform linux -- Python 3.8.10, pytest-6.2.5, py-1.11.0, pluggy-1.0.0 -- /usr/bin/python3\r\ncachedir: .pytest_cache\r\nrootdir: /home/jimb/git/spark-rapids/integration_tests\r\nplugins: xdist-2.4.0, forked-1.3.0\r\ncollecting ... collected 26674 items / 26673 deselected / 1 selected\r\n```\r\nI haven't quite nailed down why this is happening yet.  The root-dirs are the same, so I'm not sure why it's not finding the pytest.ini file.\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1977116581/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1977329152",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/10234#issuecomment-1977329152",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10234",
        "id": 1977329152,
        "node_id": "IC_kwDOD7z77c5126YA",
        "user": {
            "login": "jbrennan333",
            "id": 69316431,
            "node_id": "MDQ6VXNlcjY5MzE2NDMx",
            "avatar_url": "https://avatars.githubusercontent.com/u/69316431?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jbrennan333",
            "html_url": "https://github.com/jbrennan333",
            "followers_url": "https://api.github.com/users/jbrennan333/followers",
            "following_url": "https://api.github.com/users/jbrennan333/following{/other_user}",
            "gists_url": "https://api.github.com/users/jbrennan333/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jbrennan333/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jbrennan333/subscriptions",
            "organizations_url": "https://api.github.com/users/jbrennan333/orgs",
            "repos_url": "https://api.github.com/users/jbrennan333/repos",
            "events_url": "https://api.github.com/users/jbrennan333/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jbrennan333/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2024-03-04T19:41:32Z",
        "updated_at": "2024-03-04T19:41:32Z",
        "author_association": "COLLABORATOR",
        "body": "Actually, I didn't notice this before, because I wasn't printing the test output data in the successful run.  But it looks like in this case it is the CPU that is producing different results between 2.12 and 2.13:\r\n```\r\n2.12:\r\n\r\n--- CPU OUTPUT\r\n+++ GPU OUTPUT\r\n-Row(avg(DISTINCT a)=-9.961353300130207e+25, avg(DISTINCT b)=nan, avg(DISTINCT c)=-6.749297777543448e+17)\r\n+Row(avg(DISTINCT a)=-9.961353300130207e+25, avg(DISTINCT b)=nan, avg(DISTINCT c)=-6.74929777754345e+17)\r\n\r\n2.13\r\n--- CPU OUTPUT\r\n+++ GPU OUTPUT\r\n-Row(avg(DISTINCT a)=-9.961254917487832e+25, avg(DISTINCT b)=nan, avg(DISTINCT c)=-6.749297777543448e+17)\r\n+Row(avg(DISTINCT a)=-9.961353300130207e+25, avg(DISTINCT b)=nan, avg(DISTINCT c)=-6.74929777754345e+17)\r\n```\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1977329152/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1978990543",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/10234#issuecomment-1978990543",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10234",
        "id": 1978990543,
        "node_id": "IC_kwDOD7z77c519P_P",
        "user": {
            "login": "jbrennan333",
            "id": 69316431,
            "node_id": "MDQ6VXNlcjY5MzE2NDMx",
            "avatar_url": "https://avatars.githubusercontent.com/u/69316431?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jbrennan333",
            "html_url": "https://github.com/jbrennan333",
            "followers_url": "https://api.github.com/users/jbrennan333/followers",
            "following_url": "https://api.github.com/users/jbrennan333/following{/other_user}",
            "gists_url": "https://api.github.com/users/jbrennan333/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jbrennan333/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jbrennan333/subscriptions",
            "organizations_url": "https://api.github.com/users/jbrennan333/orgs",
            "repos_url": "https://api.github.com/users/jbrennan333/repos",
            "events_url": "https://api.github.com/users/jbrennan333/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jbrennan333/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2024-03-05T15:08:21Z",
        "updated_at": "2024-03-05T15:08:21Z",
        "author_association": "COLLABORATOR",
        "body": "[hash-debug-input.json](https://github.com/NVIDIA/spark-rapids/files/14497237/hash-debug-input.json)\r\n\r\nUploading the input data I captured from the integration test.\r\nSo far I haven't quite been able to reproduce this in spark shell.\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1978990543/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1978998855",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/10234#issuecomment-1978998855",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10234",
        "id": 1978998855,
        "node_id": "IC_kwDOD7z77c519SBH",
        "user": {
            "login": "jbrennan333",
            "id": 69316431,
            "node_id": "MDQ6VXNlcjY5MzE2NDMx",
            "avatar_url": "https://avatars.githubusercontent.com/u/69316431?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jbrennan333",
            "html_url": "https://github.com/jbrennan333",
            "followers_url": "https://api.github.com/users/jbrennan333/followers",
            "following_url": "https://api.github.com/users/jbrennan333/following{/other_user}",
            "gists_url": "https://api.github.com/users/jbrennan333/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jbrennan333/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jbrennan333/subscriptions",
            "organizations_url": "https://api.github.com/users/jbrennan333/orgs",
            "repos_url": "https://api.github.com/users/jbrennan333/repos",
            "events_url": "https://api.github.com/users/jbrennan333/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jbrennan333/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2024-03-05T15:12:09Z",
        "updated_at": "2024-03-05T15:12:09Z",
        "author_association": "COLLABORATOR",
        "body": "This is what I got running in spark shell.  I did it with just `avg(distinct a)` and also with all of them.\r\n```\r\nspark.conf.set(\"spark.rapids.sql.enabled\", false)\r\nval df=spark.read.json(\"/opt/data/jimb/hash-debug-input.json\")\r\nval adf=df.select(\"a\")\r\nadf.createOrReplaceTempView(\"input\")\r\nval sql = \"SELECT avg(distinct a) from input\"\r\nval avg = spark.sql(sql).collect\r\n```\r\n\r\n```\r\nspark shell scala 2.12:\r\nCPU: avg: Array[org.apache.spark.sql.Row] = Array([-9.961254917495146E25])           \r\nGPU: avg: Array[org.apache.spark.sql.Row] = Array([-9.961254917498747E25]) \r\n\r\nCPU: avg: Array[org.apache.spark.sql.Row] = Array([-9.961353333333334E25,NaN,-6.7492977775434509E17])\r\nGPU: avg: Array[org.apache.spark.sql.Row] = Array([-9.961353333333334E25,NaN,-6.7492977775434496E17])\r\n          \r\n\r\nspark shell 2.13\r\nCPU: val avg: Array[org.apache.spark.sql.Row] = Array([-9.961254917495146E25])\r\nGPU: val avg: Array[org.apache.spark.sql.Row] = Array([-9.961254917498747E25])\r\n\r\nCPU: val avg: Array[org.apache.spark.sql.Row] = Array([-9.961254917487832E25,NaN,-6.749297777543447E17])\r\nGPU: val avg: Array[org.apache.spark.sql.Row] = Array([-9.961254917487832E25,NaN,-6.7492977775434496E17])\r\n\r\n```",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/1978998855/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/2008101778",
        "html_url": "https://github.com/NVIDIA/spark-rapids/issues/10234#issuecomment-2008101778",
        "issue_url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/10234",
        "id": 2008101778,
        "node_id": "IC_kwDOD7z77c53sTOS",
        "user": {
            "login": "tgravescs",
            "id": 4563792,
            "node_id": "MDQ6VXNlcjQ1NjM3OTI=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4563792?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tgravescs",
            "html_url": "https://github.com/tgravescs",
            "followers_url": "https://api.github.com/users/tgravescs/followers",
            "following_url": "https://api.github.com/users/tgravescs/following{/other_user}",
            "gists_url": "https://api.github.com/users/tgravescs/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tgravescs/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tgravescs/subscriptions",
            "organizations_url": "https://api.github.com/users/tgravescs/orgs",
            "repos_url": "https://api.github.com/users/tgravescs/repos",
            "events_url": "https://api.github.com/users/tgravescs/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tgravescs/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2024-03-19T20:48:03Z",
        "updated_at": "2024-03-19T20:48:03Z",
        "author_association": "COLLABORATOR",
        "body": "saw this again in last night integration tests: DATAGEN_SEED=1710866199",
        "reactions": {
            "url": "https://api.github.com/repos/NVIDIA/spark-rapids/issues/comments/2008101778/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]